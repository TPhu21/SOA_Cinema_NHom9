<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CineMax Backoffice</title>
    <link rel="stylesheet" href="../shared/css/backoffice.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">üé¨ CineMax</div>
            <span class="role-badge" id="roleBadge"></span>
        </div>
        
        <nav class="sidebar-nav">
            <!-- Common menu items -->
            <a href="dashboard.html" class="nav-item active">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>
            
            <!-- Admin-only menu items -->
            <div id="adminMenu" style="display: none;">
                <div class="nav-section">Qu·∫£n L√Ω Phim</div>
                <a href="admin/movies.html" class="nav-item">
                    <span class="nav-icon">üé¨</span>
                    <span class="nav-text">Phim</span>
                </a>
                <a href="admin/cinemas.html" class="nav-item">
                    <span class="nav-icon">üè¢</span>
                    <span class="nav-text">R·∫°p Chi·∫øu</span>
                </a>
                <a href="admin/showtimes.html" class="nav-item">
                    <span class="nav-icon">üïê</span>
                    <span class="nav-text">Su·∫•t Chi·∫øu</span>
                </a>
                
                <div class="nav-section">Qu·∫£n L√Ω B√°n V√©</div>
                <a href="admin/bookings.html" class="nav-item">
                    <span class="nav-icon">üéüÔ∏è</span>
                    <span class="nav-text">ƒê∆°n ƒê·∫∑t V√©</span>
                </a>
                
                <div class="nav-section">H·ªá Th·ªëng</div>
                <a href="admin/users.html" class="nav-item">
                    <span class="nav-icon">üë•</span>
                    <span class="nav-text">Ng∆∞·ªùi D√πng</span>
                </a>
                <a href="admin/settings.html" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">C√†i ƒê·∫∑t</span>
                </a>
            </div>
            
            <!-- Staff-only menu items -->
            <div id="staffMenu" style="display: none;">
                <div class="nav-section">C√¥ng Vi·ªác</div>
                <a href="staff/checkin.html" class="nav-item">
                    <span class="nav-icon">‚úÖ</span>
                    <span class="nav-text">So√°t V√©</span>
                </a>
                <a href="staff/tickets.html" class="nav-item">
                    <span class="nav-icon">üé´</span>
                    <span class="nav-text">B√°n V√© Tr·ª±c Ti·∫øp</span>
                </a>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">...</div>
                </div>
            </div>
            <button class="btn-logout" onclick="handleLogout()">
                <span>üö™</span> ƒêƒÉng Xu·∫•t
            </button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <h1>Dashboard</h1>
            <div class="header-actions">
                <span class="current-time" id="currentTime"></span>
            </div>
        </header>
        
        <!-- Quick Search/Scan Section (STAFF ONLY) -->
        <section class="quick-search-section" id="quickSearchSection" style="display: none;">
            <div class="search-card">
                <h2>üîç Tra C·ª©u & Scan V√©</h2>
                <div class="search-form">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-input-large" 
                        placeholder="Nh·∫≠p m√£ v√© / m√£ booking / SƒêT / Email kh√°ch h√†ng..."
                        autocomplete="off"
                    >
                    <div class="search-buttons">
                        <button class="btn btn-primary btn-large" id="btnSearch">
                            <span>üîç</span> Tra C·ª©u
                        </button>
                        <button class="btn btn-success btn-large" id="btnScanQR">
                            <span>üì±</span> Scan QR
                        </button>
                    </div>
                </div>
                <div id="searchResult" class="search-result" style="display: none;"></div>
            </div>
        </section>

        <!-- KPI Cards -->
        <section class="kpi-section" id="kpiSection">
            <!-- S·∫Ω ƒë∆∞·ª£c render b·ªüi JS theo role -->
        </section>
        
        <!-- Alerts Panel (STAFF ONLY) -->
        <section class="alerts-section" id="alertsSection" style="display: none;">
            <h2>‚ö†Ô∏è C·∫£nh B√°o V·∫≠n H√†nh</h2>
            <div class="alerts-grid" id="alertsList">
                <div class="alert-item warning">
                    <span class="alert-icon">‚è∞</span>
                    <div class="alert-content">
                        <strong>3 su·∫•t s·∫Øp b·∫Øt ƒë·∫ßu</strong> trong 30 ph√∫t t·ªõi
                    </div>
                </div>
            </div>
        </section>

        <!-- Showtime Schedule (STAFF ONLY) -->
        <section class="showtime-section" id="showtimeSection" style="display: none;">
            <h2>üìÖ Su·∫•t Chi·∫øu H√¥m Nay</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Gi·ªù</th>
                            <th>Phim</th>
                            <th>Ph√≤ng</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>ƒê√£ B√°n</th>
                            <th>Check-in</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="showtimeList">
                        <tr><td colspan="7" style="text-align: center;">ƒêang t·∫£i...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Quick Actions - kh√°c nhau theo role -->
        <section class="quick-actions" id="quickActions">
            <!-- S·∫Ω ƒë∆∞·ª£c render b·ªüi JS theo role -->
        </section>
        
        <!-- Task Queue / Recent Activity -->
        <section class="recent-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="activityTitle">Ho·∫°t ƒê·ªông G·∫ßn ƒê√¢y</h2>
                <div id="taskFilters" style="display: none;">
                    <select class="filter-select" id="taskFilter">
                        <option value="all">T·∫•t c·∫£</option>
                        <option value="pending">ƒêang ch·ªù</option>
                        <option value="completed">Ho√†n th√†nh</option>
                    </select>
                </div>
            </div>
            <div class="activity-list" id="activityList">
                <div class="activity-item">
                    <div class="activity-icon">üéüÔ∏è</div>
                    <div class="activity-content">
                        <div class="activity-text">ƒê∆°n ƒë·∫∑t v√© m·ªõi #BK001234</div>
                        <div class="activity-time">5 ph√∫t tr∆∞·ªõc</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="../shared/js/auth.js"></script>
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:8080/api';
        
        // Helper: API call v·ªõi auth
        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : '',
                    ...(options.headers || {})
                }
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({ message: 'Network error' }));
                throw new Error(error.message || 'API call failed');
            }
            
            return response.status === 204 ? null : response.json();
        }
        
        // Ki·ªÉm tra quy·ªÅn truy c·∫≠p
        if (!requireAuth(ROLES.ADMIN, ROLES.STAFF)) {
            // requireAuth s·∫Ω t·ª± redirect
        }
        
        // Load user info
        const user = getUser();
        const role = getRole();
        
        if (user) {
            document.getElementById('userName').textContent = user.name || user.username;
            document.getElementById('userRole').textContent = role === ROLES.ADMIN ? 'Qu·∫£n tr·ªã vi√™n' : 'Nh√¢n vi√™n';
            document.getElementById('userAvatar').textContent = (user.name || user.username).charAt(0).toUpperCase();
            
            // Role badge
            const roleBadge = document.getElementById('roleBadge');
            if (role === ROLES.ADMIN) {
                roleBadge.textContent = 'üëë Admin';
                roleBadge.className = 'role-badge admin';
            } else {
                roleBadge.textContent = 'üë§ Staff';
                roleBadge.className = 'role-badge staff';
            }
        }
        
        // Show menu v√† dashboard theo role
        if (role === ROLES.ADMIN) {
            document.getElementById('adminMenu').style.display = 'block';
            renderAdminDashboard();
        } else if (role === ROLES.STAFF) {
            document.getElementById('staffMenu').style.display = 'block';
            renderStaffDashboard();
        }
        
        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('vi-VN');
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        // ========== ADMIN DASHBOARD ==========
        function renderAdminDashboard() {
            // KPI Cards cho Admin
            document.getElementById('kpiSection').innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-icon">üéüÔ∏è</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalBookings">--</div>
                        <div class="kpi-label">ƒê∆°n ƒë·∫∑t v√© h√¥m nay</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üí∞</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalRevenue">--</div>
                        <div class="kpi-label">Doanh thu h√¥m nay</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üé¨</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalMovies">--</div>
                        <div class="kpi-label">Phim ƒëang chi·∫øu</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üë•</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalCustomers">--</div>
                        <div class="kpi-label">Kh√°ch h√†ng</div>
                    </div>
                </div>
            `;
            
            // Quick Actions cho Admin
            document.getElementById('quickActions').innerHTML = `
                <h2>Thao T√°c Nhanh</h2>
                <div class="action-buttons">
                    <a href="admin/movies.html?action=add" class="action-btn">
                        <span class="action-icon">‚ûï</span>
                        <span>Th√™m Phim</span>
                    </a>
                    <a href="admin/showtimes.html?action=add" class="action-btn">
                        <span class="action-icon">üìÖ</span>
                        <span>T·∫°o Su·∫•t Chi·∫øu</span>
                    </a>
                    <a href="admin/bookings.html" class="action-btn">
                        <span class="action-icon">üìã</span>
                        <span>Xem ƒê∆°n ƒê·∫∑t</span>
                    </a>
                    <a href="admin/settings.html" class="action-btn">
                        <span class="action-icon">‚öôÔ∏è</span>
                        <span>C√†i ƒê·∫∑t</span>
                    </a>
                </div>
            `;
            
            loadAdminKPIs();
        }
        
        // ========== STAFF DASHBOARD ==========
        function renderStaffDashboard() {
            // Hi·ªÉn th·ªã Quick Search Section
            document.getElementById('quickSearchSection').style.display = 'block';
            
            // KPI Cards v·∫≠n h√†nh cho Staff
            document.getElementById('kpiSection').innerHTML = `
                <div class="kpi-card urgent">
                    <div class="kpi-icon">‚è∞</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="upcomingShowtimes">--</div>
                        <div class="kpi-label">Su·∫•t s·∫Øp chi·∫øu (30p)</div>
                    </div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-icon">‚úÖ</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="checkedInToday">--</div>
                        <div class="kpi-label">Check-in h√¥m nay</div>
                    </div>
                </div>
                <div class="kpi-card warning">
                    <div class="kpi-icon">‚è≥</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="pendingPayments">--</div>
                        <div class="kpi-label">Ch·ªù thanh to√°n</div>
                    </div>
                </div>
                <div class="kpi-card danger">
                    <div class="kpi-icon">‚ö†Ô∏è</div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="issuesCount">--</div>
                        <div class="kpi-label">C·∫£nh b√°o/S·ª± c·ªë</div>
                    </div>
                </div>
            `;
            
            // Hi·ªÉn th·ªã Alerts Section
            document.getElementById('alertsSection').style.display = 'block';
            
            // Hi·ªÉn th·ªã Showtime Table
            document.getElementById('showtimeSection').style.display = 'block';
            
            // Quick Actions cho Staff
            document.getElementById('quickActions').innerHTML = `
                <h2>Thao T√°c Nhanh</h2>
                <div class="action-buttons">
                    <a href="staff/checkin.html" class="action-btn primary">
                        <span class="action-icon">‚úÖ</span>
                        <span>So√°t V√©</span>
                    </a>
                    <a href="staff/tickets.html" class="action-btn success">
                        <span class="action-icon">üé´</span>
                        <span>B√°n V√© Tr·ª±c Ti·∫øp</span>
                    </a>
                </div>
            `;
            
            // ƒê·ªïi Activity th√†nh Task Queue
            document.getElementById('activityTitle').textContent = 'üìã C√¥ng Vi·ªác C·∫ßn X·ª≠ L√Ω';
            document.getElementById('taskFilters').style.display = 'block';
            
            // Load data cho Staff
            loadStaffKPIs();
            loadAlerts();
            loadTodayShowtimes();
            loadTaskQueue();
            initSearchHandlers();
        }
        
        // ========== STAFF: Load KPIs ==========
        async function loadStaffKPIs() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // G·ªçi API ƒë·ªÉ l·∫•y d·ªØ li·ªáu th·ª±c
                const [showtimes, bookings] = await Promise.all([
                    apiCall(`/showtimes?date=${today}`).catch(() => []),
                    apiCall(`/bookings?date=${today}`).catch(() => [])
                ]);
                
                // 1. Su·∫•t s·∫Øp chi·∫øu (30 ph√∫t t·ªõi)
                const now = new Date();
                const in30mins = new Date(now.getTime() + 30 * 60000);
                const upcomingCount = showtimes.filter(s => {
                    const showtime = new Date(s.startTime || s.time);
                    return showtime >= now && showtime <= in30mins;
                }).length;
                document.getElementById('upcomingShowtimes').textContent = upcomingCount;
                
                // 2. Check-in h√¥m nay
                const checkedIn = bookings.filter(b => b.status === 'checked_in' || b.checkedIn).length;
                const totalBookings = bookings.filter(b => b.status !== 'cancelled').length;
                document.getElementById('checkedInToday').textContent = `${checkedIn}/${totalBookings}`;
                
                // 3. Ch·ªù thanh to√°n
                const pendingCount = bookings.filter(b => 
                    b.status === 'pending' || b.paymentStatus === 'pending'
                ).length;
                document.getElementById('pendingPayments').textContent = pendingCount;
                
                // 4. C·∫£nh b√°o/S·ª± c·ªë (c√≥ th·ªÉ t√≠nh t·ª´ c√°c ƒëi·ªÅu ki·ªán)
                let issuesCount = 0;
                // Check tr√πng l·ªãch, overbooking, etc.
                const timeMap = new Map();
                showtimes.forEach(s => {
                    const key = `${s.roomId}-${s.startTime}`;
                    timeMap.set(key, (timeMap.get(key) || 0) + 1);
                });
                issuesCount = Array.from(timeMap.values()).filter(count => count > 1).length;
                issuesCount += pendingCount > 10 ? 1 : 0; // Th√™m c·∫£nh b√°o n·∫øu qu√° nhi·ªÅu pending
                document.getElementById('issuesCount').textContent = issuesCount;
                
            } catch (error) {
                console.error('Error loading staff KPIs:', error);
                // Fallback UI
                document.getElementById('upcomingShowtimes').textContent = '--';
                document.getElementById('checkedInToday').textContent = '--';
                document.getElementById('pendingPayments').textContent = '--';
                document.getElementById('issuesCount').textContent = '--';
            }
        }
        
        // ========== STAFF: Load Alerts ==========
        async function loadAlerts() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const [showtimes, bookings] = await Promise.all([
                    apiCall(`/showtimes?date=${today}`).catch(() => []),
                    apiCall(`/bookings?date=${today}`).catch(() => [])
                ]);
                
                const alerts = [];
                const now = new Date();
                const in30mins = new Date(now.getTime() + 30 * 60000);
                
                // 1. Su·∫•t s·∫Øp b·∫Øt ƒë·∫ßu
                const upcomingShowtimes = showtimes.filter(s => {
                    const showtime = new Date(s.startTime || s.time);
                    return showtime >= now && showtime <= in30mins;
                });
                if (upcomingShowtimes.length > 0) {
                    alerts.push({
                        type: 'warning',
                        icon: '‚è∞',
                        text: `${upcomingShowtimes.length} su·∫•t s·∫Øp b·∫Øt ƒë·∫ßu trong 30 ph√∫t t·ªõi`
                    });
                }
                
                // 2. Check tr√πng l·ªãch chi·∫øu
                const timeMap = new Map();
                showtimes.forEach(s => {
                    const key = `${s.roomId || s.room}-${s.startTime || s.time}`;
                    if (!timeMap.has(key)) {
                        timeMap.set(key, []);
                    }
                    timeMap.get(key).push(s);
                });
                const conflicts = Array.from(timeMap.values()).filter(arr => arr.length > 1);
                if (conflicts.length > 0) {
                    const conflict = conflicts[0];
                    const time = new Date(conflict[0].startTime || conflict[0].time).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    alerts.push({
                        type: 'danger',
                        icon: 'üö®',
                        text: `Ph√≤ng ${conflict[0].roomId || conflict[0].room} b·ªã tr√πng l·ªãch chi·∫øu (${time})`
                    });
                }
                
                // 3. Booking ch·ªù thanh to√°n qu√° l√¢u (>15 ph√∫t)
                const longPending = bookings.filter(b => {
                    if (b.status !== 'pending' && b.paymentStatus !== 'pending') return false;
                    const createdAt = new Date(b.createdAt || b.bookingTime);
                    const diff = (now - createdAt) / 60000; // minutes
                    return diff > 15;
                });
                if (longPending.length > 0) {
                    alerts.push({
                        type: 'info',
                        icon: 'üí≥',
                        text: `${longPending.length} booking ch·ªù thanh to√°n qu√° 15 ph√∫t`
                    });
                }
                
                // 4. Overbooking (n·∫øu s·ªë v√© b√°n > s·ªë gh·∫ø)
                showtimes.forEach(s => {
                    const bookingsForShowtime = bookings.filter(b => b.showtimeId === s.id);
                    const soldSeats = bookingsForShowtime.reduce((sum, b) => sum + (b.seats?.length || 0), 0);
                    if (soldSeats > (s.totalSeats || s.capacity || 100)) {
                        alerts.push({
                            type: 'danger',
                            icon: '‚ö†Ô∏è',
                            text: `Overbooking t·∫°i ${s.movieTitle || 'Su·∫•t chi·∫øu'} - ${s.roomId || s.room}`
                        });
                    }
                });
                
                // Render alerts
                if (alerts.length === 0) {
                    alerts.push({
                        type: 'info',
                        icon: '‚úÖ',
                        text: 'Kh√¥ng c√≥ c·∫£nh b√°o. H·ªá th·ªëng ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.'
                    });
                }
                
                const html = alerts.slice(0, 5).map(a => `
                    <div class="alert-item ${a.type}">
                        <span class="alert-icon">${a.icon}</span>
                        <div class="alert-content">${a.text}</div>
                    </div>
                `).join('');
                
                document.getElementById('alertsList').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading alerts:', error);
                document.getElementById('alertsList').innerHTML = `
                    <div class="alert-item danger">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <div class="alert-content">Kh√¥ng th·ªÉ t·∫£i c·∫£nh b√°o: ${error.message}</div>
                    </div>
                `;
            }
        }
        
        // ========== STAFF: Load Today Showtimes ==========
        async function loadTodayShowtimes() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const [showtimes, movies, bookings] = await Promise.all([
                    apiCall(`/showtimes?date=${today}`).catch(() => []),
                    apiCall(`/movies`).catch(() => []),
                    apiCall(`/bookings?date=${today}`).catch(() => [])
                ]);
                
                // Map movies ƒë·ªÉ l·∫•y title
                const movieMap = new Map(movies.map(m => [m.id, m.title || m.name]));
                
                // T√≠nh to√°n s·ªë gh·∫ø b√°n v√† check-in cho m·ªói su·∫•t
                const showtimesWithStats = showtimes.map(s => {
                    const showtimeBookings = bookings.filter(b => b.showtimeId === s.id);
                    const soldCount = showtimeBookings.reduce((sum, b) => sum + (b.seats?.length || 1), 0);
                    const checkinCount = showtimeBookings
                        .filter(b => b.status === 'checked_in' || b.checkedIn)
                        .reduce((sum, b) => sum + (b.seats?.length || 1), 0);
                    
                    return {
                        ...s,
                        soldCount,
                        checkinCount,
                        movieTitle: movieMap.get(s.movieId) || s.movieTitle || 'Unknown Movie'
                    };
                });
                
                // Sort theo th·ªùi gian
                showtimesWithStats.sort((a, b) => {
                    const timeA = new Date(a.startTime || a.time);
                    const timeB = new Date(b.startTime || b.time);
                    return timeA - timeB;
                });
                
                const getStatusBadge = (showtime) => {
                    const now = new Date();
                    const startTime = new Date(showtime.startTime || showtime.time);
                    const endTime = new Date(startTime.getTime() + (showtime.duration || 120) * 60000);
                    
                    if (now < startTime) {
                        return '<span class="badge badge-warning">S·∫Øp chi·∫øu</span>';
                    } else if (now >= startTime && now < endTime) {
                        return '<span class="badge badge-success">ƒêang chi·∫øu</span>';
                    } else {
                        return '<span class="badge badge-secondary">K·∫øt th√∫c</span>';
                    }
                };
                
                const formatTime = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                };
                
                const html = showtimesWithStats.slice(0, 20).map(s => {
                    const totalSeats = s.totalSeats || s.capacity || 100;
                    return `
                        <tr>
                            <td><strong>${formatTime(s.startTime || s.time)}</strong></td>
                            <td>${s.movieTitle}</td>
                            <td>${s.roomName || s.room || `Ph√≤ng ${s.roomId}`}</td>
                            <td>${getStatusBadge(s)}</td>
                            <td>${s.soldCount}/${totalSeats}</td>
                            <td>${s.checkinCount}/${s.soldCount}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="openCheckin('${s.id}')">So√°t V√©</button>
                                <button class="btn btn-sm btn-success" onclick="openSell('${s.id}')">B√°n V√©</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('showtimeList').innerHTML = html || 
                    '<tr><td colspan="7" style="text-align: center;">Kh√¥ng c√≥ su·∫•t chi·∫øu h√¥m nay</td></tr>';
                
            } catch (error) {
                console.error('Error loading showtimes:', error);
                document.getElementById('showtimeList').innerHTML = 
                    `<tr><td colspan="7" style="text-align: center; color: #ef4444;">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</td></tr>`;
            }
        }
        
        // ========== STAFF: Task Queue ==========
        async function loadTaskQueue() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const bookings = await apiCall(`/bookings?date=${today}`).catch(() => []);
                
                const tasks = [];
                const now = new Date();
                
                // 1. Booking ch·ªù thanh to√°n
                bookings
                    .filter(b => b.status === 'pending' || b.paymentStatus === 'pending')
                    .slice(0, 5)
                    .forEach(b => {
                        tasks.push({
                            icon: '‚è≥',
                            text: `Booking #${b.bookingCode || b.id} ch·ªù thanh to√°n (SƒêT: ${b.customerPhone || 'N/A'})`,
                            action: 'Xem chi ti·∫øt',
                            status: 'pending',
                            bookingId: b.id
                        });
                    });
                
                // 2. V√© c·∫ßn check-in (su·∫•t s·∫Øp chi·∫øu)
                const upcomingBookings = bookings.filter(b => {
                    if (b.status === 'checked_in' || b.checkedIn) return false;
                    if (b.status === 'cancelled') return false;
                    const showtime = new Date(b.showtimeTime || b.showtime);
                    const diff = (showtime - now) / 60000; // minutes
                    return diff > 0 && diff <= 30;
                });
                upcomingBookings.slice(0, 3).forEach(b => {
                    tasks.push({
                        icon: 'üéüÔ∏è',
                        text: `Check-in v√© #${b.ticketCode || b.bookingCode || b.id} (${b.roomName || 'Ph√≤ng ' + b.roomId})`,
                        action: 'Check-in',
                        status: 'pending',
                        bookingId: b.id
                    });
                });
                
                // 3. Y√™u c·∫ßu ƒë·ªïi gh·∫ø / h·ªßy v√© (n·∫øu c√≥ tr∆∞·ªùng flagged)
                bookings
                    .filter(b => b.changeRequest || b.refundRequest)
                    .slice(0, 3)
                    .forEach(b => {
                        tasks.push({
                            icon: 'üîÑ',
                            text: `Y√™u c·∫ßu ${b.changeRequest ? 'ƒë·ªïi gh·∫ø' : 'ho√†n ti·ªÅn'} #${b.bookingCode || b.id}`,
                            action: 'X·ª≠ l√Ω',
                            status: 'pending',
                            bookingId: b.id
                        });
                    });
                
                // Filter theo taskFilter
                const filter = document.getElementById('taskFilter')?.value || 'all';
                let filteredTasks = tasks;
                if (filter === 'pending') {
                    filteredTasks = tasks.filter(t => t.status === 'pending');
                } else if (filter === 'completed') {
                    filteredTasks = tasks.filter(t => t.status === 'completed');
                }
                
                const html = filteredTasks.length > 0 ? filteredTasks.map(t => `
                    <div class="activity-item ${t.status}">
                        <div class="activity-icon">${t.icon}</div>
                        <div class="activity-content">
                            <div class="activity-text">${t.text}</div>
                            <button class="btn btn-sm btn-primary" onclick="handleTask('${t.bookingId}')">${t.action}</button>
                        </div>
                    </div>
                `).join('') : `
                    <div class="activity-item">
                        <div class="activity-icon">‚úÖ</div>
                        <div class="activity-content">
                            <div class="activity-text">Kh√¥ng c√≥ c√¥ng vi·ªác ƒëang ch·ªù x·ª≠ l√Ω</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('activityList').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading task queue:', error);
                document.getElementById('activityList').innerHTML = `
                    <div class="activity-item danger">
                        <div class="activity-icon">‚ö†Ô∏è</div>
                        <div class="activity-content">
                            <div class="activity-text">L·ªói t·∫£i c√¥ng vi·ªác: ${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Handle task action
        function handleTask(bookingId) {
            window.location.href = `admin/bookings.html?id=${bookingId}`;
        }
        
        // ========== STAFF: Search Handlers ==========
        function initSearchHandlers() {
            const searchInput = document.getElementById('searchInput');
            const btnSearch = document.getElementById('btnSearch');
            const btnScanQR = document.getElementById('btnScanQR');
            const taskFilter = document.getElementById('taskFilter');
            
            btnSearch.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
            
            btnScanQR.addEventListener('click', () => {
                alert('T√≠nh nƒÉng Scan QR ƒëang ph√°t tri·ªÉn. S·∫Ω m·ªü camera/scanner.');
            });
            
            // Task filter
            if (taskFilter) {
                taskFilter.addEventListener('change', loadTaskQueue);
            }
        }
        
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Vui l√≤ng nh·∫≠p m√£ v√©, booking ho·∫∑c SƒêT ƒë·ªÉ tra c·ª©u');
                return;
            }
            
            const resultDiv = document.getElementById('searchResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<div class="search-loading">ƒêang tra c·ª©u "${query}"...</div>`;
            
            try {
                // T√¨m ki·∫øm theo nhi·ªÅu ti√™u ch√≠
                let booking = null;
                
                // 1. T√¨m theo booking code/ID
                try {
                    booking = await apiCall(`/bookings/${query}`);
                } catch (e) {
                    // N·∫øu kh√¥ng t√¨m th·∫•y theo ID, th·ª≠ search
                }
                
                // 2. N·∫øu ch∆∞a t√¨m th·∫•y, search theo phone/email
                if (!booking) {
                    const bookings = await apiCall(`/bookings/search?query=${encodeURIComponent(query)}`);
                    if (bookings && bookings.length > 0) {
                        booking = bookings[0];
                    }
                }
                
                if (!booking) {
                    resultDiv.innerHTML = `
                        <div class="search-item">
                            <h3 style="color: #ef4444;">‚ùå Kh√¥ng t√¨m th·∫•y</h3>
                            <p>Kh√¥ng c√≥ booking n√†o v·ªõi m√£ "${query}"</p>
                        </div>
                    `;
                    return;
                }
                
                // L·∫•y th√¥ng tin chi ti·∫øt
                const [movie, showtime] = await Promise.all([
                    apiCall(`/movies/${booking.movieId}`).catch(() => ({ title: 'N/A' })),
                    apiCall(`/showtimes/${booking.showtimeId}`).catch(() => ({}))
                ]);
                
                const statusBadge = booking.status === 'confirmed' || booking.status === 'paid' 
                    ? '<span class="badge badge-success">ƒê√£ thanh to√°n</span>'
                    : booking.status === 'checked_in' || booking.checkedIn
                    ? '<span class="badge badge-info">ƒê√£ check-in</span>'
                    : '<span class="badge badge-warning">Ch·ªù thanh to√°n</span>';
                
                const formatTime = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    const date = new Date(dateStr);
                    return date.toLocaleString('vi-VN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        day: '2-digit',
                        month: '2-digit'
                    });
                };
                
                resultDiv.innerHTML = `
                    <div class="search-item">
                        <h3>K·∫øt qu·∫£: Booking #${booking.bookingCode || booking.id}</h3>
                        <p><strong>Kh√°ch h√†ng:</strong> ${booking.customerName || 'N/A'} (${booking.customerPhone || booking.customerEmail || 'N/A'})</p>
                        <p><strong>Phim:</strong> ${movie.title || booking.movieTitle || 'N/A'}</p>
                        <p><strong>Su·∫•t chi·∫øu:</strong> ${formatTime(showtime.startTime || booking.showtimeTime)}, ${showtime.roomName || booking.roomName || 'Ph√≤ng ' + (showtime.roomId || booking.roomId)}</p>
                        <p><strong>Gh·∫ø:</strong> ${booking.seats ? booking.seats.join(', ') : booking.seatNumbers || 'N/A'}</p>
                        <p><strong>S·ªë l∆∞·ª£ng:</strong> ${booking.quantity || booking.seats?.length || 1} v√©</p>
                        <p><strong>T·ªïng ti·ªÅn:</strong> ${(booking.totalAmount || booking.total || 0).toLocaleString('vi-VN')} VNƒê</p>
                        <p><strong>Tr·∫°ng th√°i:</strong> ${statusBadge}</p>
                        ${booking.status !== 'checked_in' && !booking.checkedIn ? `
                            <button class="btn btn-primary" onclick="checkInTicket('${booking.id}')">Check-in</button>
                        ` : '<p style="color: #22c55e;">‚úÖ ƒê√£ check-in</p>'}
                    </div>
                `;
                
            } catch (error) {
                console.error('Search error:', error);
                resultDiv.innerHTML = `
                    <div class="search-item">
                        <h3 style="color: #ef4444;">‚ö†Ô∏è L·ªói tra c·ª©u</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function checkInTicket(bookingId) {
            if (!confirm(`X√°c nh·∫≠n check-in booking #${bookingId}?`)) return;
            
            try {
                await apiCall(`/bookings/${bookingId}/checkin`, {
                    method: 'POST'
                });
                
                alert('‚úÖ Check-in th√†nh c√¥ng!');
                loadStaffKPIs();
                loadTaskQueue();
                loadTodayShowtimes();
                performSearch(); // Refresh search result
                
            } catch (error) {
                alert('‚ùå L·ªói check-in: ' + error.message);
            }
        }
        
        function openCheckin(showtimeId) {
            window.location.href = `staff/checkin.html?showtimeId=${showtimeId}`;
        }
        
        function openSell(showtimeId) {
            window.location.href = `staff/tickets.html?showtimeId=${showtimeId}`;
        }
        
        // ========== ADMIN: Load KPIs ==========
        async function loadAdminKPIs() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // G·ªçi c√°c API song song
                const [bookings, movies] = await Promise.all([
                    apiCall(`/bookings?date=${today}`).catch(() => []),
                    apiCall(`/movies`).catch(() => [])
                ]);
                
                // 1. T·ªïng ƒë∆°n ƒë·∫∑t v√© h√¥m nay
                const totalBookings = bookings.filter(b => b.status !== 'cancelled').length;
                document.getElementById('totalBookings').textContent = totalBookings;
                
                // 2. Doanh thu h√¥m nay
                const revenue = bookings
                    .filter(b => b.status === 'confirmed' || b.status === 'paid' || b.status === 'checked_in')
                    .reduce((sum, b) => sum + (b.totalAmount || b.total || 0), 0);
                const revenueM = (revenue / 1000000).toFixed(1);
                document.getElementById('totalRevenue').textContent = `${revenueM}M`;
                
                // 3. S·ªë phim ƒëang chi·∫øu
                const nowShowingMovies = movies.filter(m => m.status === 'now_showing' || m.nowShowing).length;
                document.getElementById('totalMovies').textContent = nowShowingMovies || movies.length;
                
                // 4. S·ªë kh√°ch h√†ng (unique customers)
                const uniqueCustomers = new Set(bookings.map(b => b.customerId || b.customerPhone || b.customerEmail)).size;
                document.getElementById('totalCustomers').textContent = uniqueCustomers.toLocaleString('vi-VN');
                
            } catch (error) {
                console.error('Error loading admin KPIs:', error);
                document.getElementById('totalBookings').textContent = '--';
                document.getElementById('totalRevenue').textContent = '--';
                document.getElementById('totalMovies').textContent = '--';
                document.getElementById('totalCustomers').textContent = '--';
            }
        }
        
        // Logout handler
        function handleLogout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                logout();
                window.location.href = 'login.html';
            }
        }
        
        // TODO: Load KPIs t·ª´ API
        // loadDashboardData();
    </script>
</body>
</html>
