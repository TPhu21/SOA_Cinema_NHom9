<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°n V√© Tr·ª±c Ti·∫øp - CineMax Staff</title>
    <link rel="stylesheet" href="../../shared/css/backoffice.css">
    <style>
        .booking-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .booking-container {
                grid-template-columns: 1fr;
            }
        }
        
        .selection-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
        }
        
        .selection-step {
            margin-bottom: 25px;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            background: var(--primary-gold);
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .step-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .movie-card {
            background: rgba(255,255,255,0.03);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .movie-card:hover {
            background: rgba(255,255,255,0.08);
        }
        
        .movie-card.selected {
            border-color: var(--primary-gold);
            background: rgba(255, 184, 0, 0.1);
        }
        
        .movie-poster {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            margin-bottom: 8px;
        }
        
        .movie-title {
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .showtime-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .showtime-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .showtime-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .showtime-btn.selected {
            background: var(--primary-gold);
            color: #000;
            border-color: var(--primary-gold);
        }
        
        .showtime-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .showtime-time {
            font-weight: 700;
        }
        
        .showtime-room {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        /* Seat Map */
        .seat-map-container {
            margin-top: 15px;
        }
        
        .screen {
            background: linear-gradient(to bottom, var(--primary-gold), transparent);
            height: 40px;
            border-radius: 5px 5px 50% 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 600;
            margin-bottom: 25px;
        }
        
        .seat-grid {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }
        
        .seat-row {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .row-label {
            width: 25px;
            text-align: center;
            font-weight: 600;
            color: var(--text-muted);
        }
        
        .seat {
            width: 32px;
            height: 32px;
            border-radius: 5px 5px 8px 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.2s;
        }
        
        .seat:hover:not(.booked):not(.selected) {
            background: rgba(255,255,255,0.2);
        }
        
        .seat.selected {
            background: var(--primary-gold);
            color: #000;
            border-color: var(--primary-gold);
        }
        
        .seat.booked {
            background: #ef4444;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .seat.vip {
            border-color: #a855f7;
        }
        
        .seat.vip.selected {
            background: #a855f7;
            border-color: #a855f7;
        }
        
        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }
        
        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .legend-box.available {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .legend-box.selected {
            background: var(--primary-gold);
        }
        
        .legend-box.booked {
            background: #ef4444;
        }
        
        .legend-box.vip {
            border: 2px solid #a855f7;
            background: transparent;
        }
        
        /* Order Summary */
        .order-summary {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            position: sticky;
            top: 20px;
        }
        
        .summary-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
        }
        
        .summary-label {
            color: var(--text-muted);
        }
        
        .summary-value {
            font-weight: 500;
        }
        
        .summary-divider {
            border-top: 1px dashed var(--border-color);
            margin: 10px 0;
        }
        
        .summary-total {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-gold);
        }
        
        .selected-seats {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .selected-seats span {
            background: rgba(255, 184, 0, 0.2);
            color: var(--primary-gold);
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.85rem;
        }
        
        .customer-info {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .customer-info .form-group {
            margin-bottom: 10px;
        }
        
        .customer-info label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .customer-info input {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .payment-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .payment-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .payment-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .payment-btn.selected {
            border-color: var(--primary-gold);
            background: rgba(255, 184, 0, 0.1);
        }
        
        .payment-btn .icon {
            font-size: 1.5rem;
        }
        
        .payment-btn .name {
            font-size: 0.75rem;
            margin-top: 3px;
        }
        
        .btn-checkout {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">üé¨ CineMax</div>
            <span class="role-badge staff">üë®‚Äçüíº Staff</span>
        </div>
        
        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>
            
            <div class="nav-section">C√¥ng Vi·ªác</div>
            <a href="checkin.html" class="nav-item">
                <span class="nav-icon">‚úÖ</span>
                <span class="nav-text">So√°t V√©</span>
            </a>
            <a href="tickets.html" class="nav-item active">
                <span class="nav-icon">üé´</span>
                <span class="nav-text">B√°n V√©</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">S</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Staff</div>
                    <div class="user-role">Nh√¢n vi√™n</div>
                </div>
            </div>
            <button class="btn-logout" onclick="handleLogout()">
                <span>üö™</span> ƒêƒÉng Xu·∫•t
            </button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <h1>üé´ B√°n V√© Tr·ª±c Ti·∫øp</h1>
        </header>
        
        <div class="booking-container">
            <!-- Selection Panel -->
            <div class="selection-panel">
                <!-- Step 1: Ch·ªçn Phim -->
                <div class="selection-step" id="step1">
                    <div class="step-header">
                        <span class="step-number">1</span>
                        <span class="step-title">Ch·ªçn Phim</span>
                    </div>
                    <div class="movie-grid" id="movieGrid">
                        <!-- Will be filled by JS -->
                    </div>
                </div>
                
                <!-- Step 2: Ch·ªçn Su·∫•t Chi·∫øu -->
                <div class="selection-step" id="step2" style="display: none;">
                    <div class="step-header">
                        <span class="step-number">2</span>
                        <span class="step-title">Ch·ªçn Su·∫•t Chi·∫øu</span>
                    </div>
                    <div class="showtime-grid" id="showtimeGrid">
                        <!-- Will be filled by JS -->
                    </div>
                </div>
                
                <!-- Step 3: Ch·ªçn Gh·∫ø -->
                <div class="selection-step" id="step3" style="display: none;">
                    <div class="step-header">
                        <span class="step-number">3</span>
                        <span class="step-title">Ch·ªçn Gh·∫ø</span>
                    </div>
                    <div class="seat-map-container">
                        <div class="screen">M√ÄN H√åNH</div>
                        <div class="seat-grid" id="seatGrid">
                            <!-- Will be filled by JS -->
                        </div>
                        <div class="seat-legend">
                            <div class="legend-item">
                                <div class="legend-box available"></div>
                                <span>Tr·ªëng</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box selected"></div>
                                <span>ƒêang ch·ªçn</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box booked"></div>
                                <span>ƒê√£ ƒë·∫∑t</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-box vip"></div>
                                <span>Gh·∫ø VIP</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="order-summary">
                <div class="summary-title">üßæ Th√¥ng Tin ƒê·∫∑t V√©</div>
                
                <div class="summary-row">
                    <span class="summary-label">Phim:</span>
                    <span class="summary-value" id="summaryMovie">--</span>
                </div>
                
                <div class="summary-row">
                    <span class="summary-label">Su·∫•t:</span>
                    <span class="summary-value" id="summaryShowtime">--</span>
                </div>
                
                <div class="summary-row">
                    <span class="summary-label">Ph√≤ng:</span>
                    <span class="summary-value" id="summaryRoom">--</span>
                </div>
                
                <div class="summary-row">
                    <span class="summary-label">Gh·∫ø:</span>
                </div>
                <div class="selected-seats" id="summarySeats">
                    <span style="opacity: 0.5">Ch∆∞a ch·ªçn</span>
                </div>
                
                <div class="summary-divider"></div>
                
                <div class="summary-row">
                    <span class="summary-label">S·ªë v√©:</span>
                    <span class="summary-value" id="summaryTicketCount">0</span>
                </div>
                
                <div class="summary-row">
                    <span class="summary-label">T·ªïng ti·ªÅn:</span>
                    <span class="summary-value summary-total" id="summaryTotal">0ƒë</span>
                </div>
                
                <!-- Customer Info -->
                <div class="customer-info">
                    <div class="form-group">
                        <label>T√™n kh√°ch h√†ng</label>
                        <input type="text" class="form-control" id="customerName" placeholder="Nh·∫≠p t√™n...">
                    </div>
                    <div class="form-group">
                        <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                        <input type="tel" class="form-control" id="customerPhone" placeholder="0901234567" required>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label style="margin-bottom: 8px; display: block; color: var(--text-muted);">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                    <div class="payment-methods">
                        <div class="payment-btn selected" onclick="selectPayment('CASH')">
                            <div class="icon">üíµ</div>
                            <div class="name">Ti·ªÅn m·∫∑t</div>
                        </div>
                        <div class="payment-btn" onclick="selectPayment('CARD')">
                            <div class="icon">üí≥</div>
                            <div class="name">Th·∫ª</div>
                        </div>
                        <div class="payment-btn" onclick="selectPayment('MOMO')">
                            <div class="icon">üì±</div>
                            <div class="name">MoMo</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-checkout" onclick="checkout()" id="checkoutBtn" disabled>
                    üéüÔ∏è Xu·∫•t V√©
                </button>
            </div>
        </div>
    </main>

    <script src="../../shared/js/auth.js"></script>
    <script>
        // Ki·ªÉm tra quy·ªÅn Staff
        if (!requireAuth(ROLES.STAFF)) {
            // requireAuth s·∫Ω t·ª± redirect
        }
        
        // Load user info
        const user = getUser();
        if (user) {
            document.getElementById('userName').textContent = user.name || user.username;
            document.getElementById('userAvatar').textContent = (user.name || user.username).charAt(0).toUpperCase();
        }
        
        // State
        let selectedMovie = null;
        let selectedShowtime = null;
        let selectedSeats = [];
        let selectedPayment = 'CASH';
        const seatPrice = { regular: 75000, vip: 95000 };
        
        // Load movies on page load
        loadMovies();
        
        async function loadMovies() {
            // DEMO data
            const movies = [
                { id: 1, title: 'Avengers: Endgame', poster: '' },
                { id: 2, title: 'Spider-Man: No Way Home', poster: '' },
                { id: 3, title: 'The Batman', poster: '' },
                { id: 4, title: 'Doctor Strange 2', poster: '' },
            ];
            
            const grid = document.getElementById('movieGrid');
            grid.innerHTML = movies.map(m => `
                <div class="movie-card" onclick="selectMovie(${m.id}, '${m.title}')">
                    <img src="${m.poster || 'https://via.placeholder.com/150x100?text=' + encodeURIComponent(m.title.substring(0, 10))}" 
                         class="movie-poster" alt="${m.title}">
                    <div class="movie-title">${m.title}</div>
                </div>
            `).join('');
        }
        
        function selectMovie(id, title) {
            selectedMovie = { id, title };
            selectedShowtime = null;
            selectedSeats = [];
            
            // Update UI
            document.querySelectorAll('.movie-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            document.getElementById('summaryMovie').textContent = title;
            document.getElementById('summaryShowtime').textContent = '--';
            document.getElementById('summaryRoom').textContent = '--';
            updateSummary();
            
            // Show step 2
            document.getElementById('step2').style.display = 'block';
            document.getElementById('step3').style.display = 'none';
            
            loadShowtimes(id);
        }
        
        async function loadShowtimes(movieId) {
            // DEMO data
            const showtimes = [
                { id: 1, time: '10:00', room: 'Ph√≤ng 1', available: 45 },
                { id: 2, time: '12:30', room: 'Ph√≤ng 2', available: 20 },
                { id: 3, time: '15:00', room: 'Ph√≤ng 1', available: 0 },
                { id: 4, time: '17:30', room: 'Ph√≤ng 3', available: 80 },
                { id: 5, time: '20:00', room: 'Ph√≤ng 2', available: 15 },
                { id: 6, time: '22:30', room: 'Ph√≤ng 1', available: 60 },
            ];
            
            const grid = document.getElementById('showtimeGrid');
            grid.innerHTML = showtimes.map(st => `
                <button class="showtime-btn ${st.available === 0 ? 'disabled' : ''}" 
                        onclick="${st.available > 0 ? `selectShowtime(${st.id}, '${st.time}', '${st.room}')` : ''}"
                        ${st.available === 0 ? 'disabled' : ''}>
                    <div class="showtime-time">${st.time}</div>
                    <div class="showtime-room">${st.room} (${st.available} gh·∫ø)</div>
                </button>
            `).join('');
        }
        
        function selectShowtime(id, time, room) {
            selectedShowtime = { id, time, room };
            selectedSeats = [];
            
            // Update UI
            document.querySelectorAll('.showtime-btn').forEach(b => b.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            document.getElementById('summaryShowtime').textContent = time;
            document.getElementById('summaryRoom').textContent = room;
            updateSummary();
            
            // Show step 3
            document.getElementById('step3').style.display = 'block';
            loadSeats(id);
        }
        
        function loadSeats(showtimeId) {
            const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            const cols = 12;
            const vipRows = ['E', 'F', 'G'];
            
            // Random booked seats
            const bookedSeats = ['A3', 'A4', 'B5', 'C7', 'C8', 'D2', 'E5', 'E6', 'E7', 'F4', 'F5', 'G8', 'H1'];
            
            const grid = document.getElementById('seatGrid');
            grid.innerHTML = rows.map(row => {
                const seatsHtml = Array.from({ length: cols }, (_, i) => {
                    const col = i + 1;
                    const seatId = `${row}${col}`;
                    const isBooked = bookedSeats.includes(seatId);
                    const isVip = vipRows.includes(row);
                    
                    return `
                        <div class="seat ${isBooked ? 'booked' : ''} ${isVip ? 'vip' : ''}" 
                             data-seat="${seatId}"
                             onclick="${isBooked ? '' : `toggleSeat('${seatId}', ${isVip})`}">
                            ${col}
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="seat-row">
                        <span class="row-label">${row}</span>
                        ${seatsHtml}
                        <span class="row-label">${row}</span>
                    </div>
                `;
            }).join('');
        }
        
        function toggleSeat(seatId, isVip) {
            const seatEl = document.querySelector(`[data-seat="${seatId}"]`);
            
            if (seatEl.classList.contains('selected')) {
                seatEl.classList.remove('selected');
                selectedSeats = selectedSeats.filter(s => s.id !== seatId);
            } else {
                seatEl.classList.add('selected');
                selectedSeats.push({ id: seatId, isVip });
            }
            
            updateSummary();
        }
        
        function updateSummary() {
            const seatsContainer = document.getElementById('summarySeats');
            const ticketCount = document.getElementById('summaryTicketCount');
            const totalEl = document.getElementById('summaryTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (selectedSeats.length === 0) {
                seatsContainer.innerHTML = '<span style="opacity: 0.5">Ch∆∞a ch·ªçn</span>';
                ticketCount.textContent = '0';
                totalEl.textContent = '0ƒë';
                checkoutBtn.disabled = true;
            } else {
                seatsContainer.innerHTML = selectedSeats.map(s => `<span>${s.id}</span>`).join('');
                ticketCount.textContent = selectedSeats.length;
                
                const total = selectedSeats.reduce((sum, s) => {
                    return sum + (s.isVip ? seatPrice.vip : seatPrice.regular);
                }, 0);
                
                totalEl.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(total);
                checkoutBtn.disabled = false;
            }
        }
        
        function selectPayment(method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }
        
        function checkout() {
            const phone = document.getElementById('customerPhone').value.trim();
            
            if (!phone) {
                alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng');
                return;
            }
            
            if (selectedSeats.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 gh·∫ø');
                return;
            }
            
            const customerName = document.getElementById('customerName').value.trim() || 'Kh√°ch l·∫ª';
            const total = selectedSeats.reduce((sum, s) => sum + (s.isVip ? seatPrice.vip : seatPrice.regular), 0);
            
            const bookingInfo = {
                movie: selectedMovie.title,
                showtime: selectedShowtime.time,
                room: selectedShowtime.room,
                seats: selectedSeats.map(s => s.id),
                customer: { name: customerName, phone },
                payment: selectedPayment,
                total
            };
            
            console.log('Booking:', bookingInfo);
            
            // TODO: Call API to create booking
            
            const bookingCode = 'BK' + Date.now().toString().slice(-8);
            
            alert(`‚úÖ ƒê√£ xu·∫•t v√© th√†nh c√¥ng!\n\nM√£ v√©: ${bookingCode}\nPhim: ${selectedMovie.title}\nSu·∫•t: ${selectedShowtime.time} - ${selectedShowtime.room}\nGh·∫ø: ${selectedSeats.map(s => s.id).join(', ')}\nKh√°ch: ${customerName} - ${phone}\nThanh to√°n: ${selectedPayment}\nT·ªïng: ${new Intl.NumberFormat('vi-VN').format(total)}ƒë`);
            
            // Reset
            selectedMovie = null;
            selectedShowtime = null;
            selectedSeats = [];
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            document.querySelectorAll('.movie-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('summaryMovie').textContent = '--';
            document.getElementById('summaryShowtime').textContent = '--';
            document.getElementById('summaryRoom').textContent = '--';
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            updateSummary();
        }
        
        function handleLogout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                logout();
                window.location.href = '../login.html';
            }
        }
    </script>
</body>
</html>
