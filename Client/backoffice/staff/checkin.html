<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>So√°t V√© - CineMax Staff</title>
    <link rel="stylesheet" href="../../shared/css/backoffice.css">
    <style>
        .checkin-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .scan-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .scan-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .scan-input {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .scan-input input {
            flex: 1;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1.2rem;
            text-align: center;
            letter-spacing: 2px;
        }
        
        .scan-input input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .scan-input button {
            padding: 15px 30px;
            font-size: 1.1rem;
        }
        
        .result-section {
            display: none;
        }
        
        .result-section.show {
            display: block;
        }
        
        .ticket-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .ticket-card.valid {
            border-color: var(--success-color);
        }
        
        .ticket-card.invalid {
            border-color: var(--danger-color);
        }
        
        .ticket-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .ticket-header.valid {
            background: rgba(34, 197, 94, 0.2);
        }
        
        .ticket-header.invalid {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .ticket-status-icon {
            font-size: 2.5rem;
        }
        
        .ticket-status-text h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }
        
        .ticket-body {
            padding: 25px;
        }
        
        .ticket-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .ticket-info-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }
        
        .ticket-info-item.full-width {
            grid-column: span 2;
        }
        
        .ticket-info-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        .ticket-info-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .ticket-actions {
            padding: 20px 25px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
        }
        
        .ticket-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 15px;
            font-size: 1rem;
        }
        
        .history-section {
            margin-top: 30px;
        }
        
        .history-section h2 {
            margin-bottom: 20px;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .history-icon {
            font-size: 1.5rem;
        }
        
        .history-icon.success { color: var(--success-color); }
        .history-icon.error { color: var(--danger-color); }
        
        .history-info {
            flex: 1;
        }
        
        .history-code {
            font-weight: 600;
        }
        
        .history-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">üé¨ CineMax</div>
            <span class="role-badge staff">üë§ Staff</span>
        </div>
        
        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>
            
            <div class="nav-section">C√¥ng Vi·ªác</div>
            <a href="checkin.html" class="nav-item active">
                <span class="nav-icon">‚úÖ</span>
                <span class="nav-text">So√°t V√©</span>
            </a>
            <a href="tickets.html" class="nav-item">
                <span class="nav-icon">üé´</span>
                <span class="nav-text">B√°n V√© Tr·ª±c Ti·∫øp</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">S</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Staff</div>
                    <div class="user-role">Nh√¢n vi√™n</div>
                </div>
            </div>
            <button class="btn-logout" onclick="handleLogout()">
                <span>üö™</span> ƒêƒÉng Xu·∫•t
            </button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <h1>‚úÖ So√°t V√©</h1>
            <div class="header-actions">
                <span class="current-time" id="currentTime"></span>
            </div>
        </header>
        
        <div class="checkin-container">
            <!-- Scan Section -->
            <section class="scan-section">
                <div class="scan-icon">üì±</div>
                <h2>Qu√©t m√£ v√© ho·∫∑c nh·∫≠p m√£</h2>
                <p style="color: var(--text-muted); margin-top: 10px;">
                    Nh·∫≠p m√£ ƒë·∫∑t v√© ƒë·ªÉ ki·ªÉm tra v√† x√°c nh·∫≠n check-in
                </p>
                
                <div class="scan-input">
                    <input type="text" id="bookingCode" placeholder="VD: BK123456" 
                           maxlength="20" autocomplete="off" autofocus>
                    <button class="btn btn-primary" onclick="checkTicket()">
                        üîç Ki·ªÉm Tra
                    </button>
                </div>
            </section>
            
            <!-- Result Section -->
            <section class="result-section" id="resultSection">
                <div class="ticket-card" id="ticketCard">
                    <div class="ticket-header" id="ticketHeader">
                        <div class="ticket-status-icon" id="statusIcon">‚úÖ</div>
                        <div class="ticket-status-text">
                            <h3 id="statusTitle">V√© h·ª£p l·ªá</h3>
                            <p id="statusDesc">C√≥ th·ªÉ cho kh√°ch v√†o r·∫°p</p>
                        </div>
                    </div>
                    
                    <div class="ticket-body">
                        <div class="ticket-info">
                            <div class="ticket-info-item full-width">
                                <div class="ticket-info-label">Phim</div>
                                <div class="ticket-info-value" id="movieName">--</div>
                            </div>
                            <div class="ticket-info-item">
                                <div class="ticket-info-label">Ng√†y chi·∫øu</div>
                                <div class="ticket-info-value" id="showDate">--</div>
                            </div>
                            <div class="ticket-info-item">
                                <div class="ticket-info-label">Gi·ªù chi·∫øu</div>
                                <div class="ticket-info-value" id="showTime">--</div>
                            </div>
                            <div class="ticket-info-item">
                                <div class="ticket-info-label">R·∫°p / Ph√≤ng</div>
                                <div class="ticket-info-value" id="cinema">--</div>
                            </div>
                            <div class="ticket-info-item">
                                <div class="ticket-info-label">Gh·∫ø</div>
                                <div class="ticket-info-value" id="seats">--</div>
                            </div>
                            <div class="ticket-info-item full-width">
                                <div class="ticket-info-label">Kh√°ch h√†ng</div>
                                <div class="ticket-info-value" id="customer">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ticket-actions" id="ticketActions">
                        <button class="btn btn-success" onclick="confirmCheckin()">
                            ‚úÖ X√°c Nh·∫≠n Check-in
                        </button>
                        <button class="btn btn-outline" onclick="clearResult()">
                            ‚Ü©Ô∏è Qu√©t V√© Kh√°c
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- History Section -->
            <section class="history-section">
                <h2>L·ªãch s·ª≠ so√°t v√©</h2>
                <div id="historyList">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                        Ch∆∞a c√≥ l·ªãch s·ª≠ so√°t v√©
                    </p>
                </div>
            </section>
        </div>
    </main>

    <script src="../../shared/js/auth.js"></script>
    <script>
        // Ki·ªÉm tra quy·ªÅn
        if (!requireAuth(ROLES.STAFF, ROLES.ADMIN)) {
            // requireAuth s·∫Ω t·ª± redirect
        }
        
        // Load user info
        const user = getUser();
        if (user) {
            document.getElementById('userName').textContent = user.name || user.username;
            document.getElementById('userAvatar').textContent = (user.name || user.username).charAt(0).toUpperCase();
        }
        
        // Update time
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('vi-VN');
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        // Enter to search
        document.getElementById('bookingCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkTicket();
        });
        
        // Check ticket
        async function checkTicket() {
            const code = document.getElementById('bookingCode').value.trim().toUpperCase();
            
            if (!code) {
                alert('Vui l√≤ng nh·∫≠p m√£ v√©');
                return;
            }
            
            try {
                // TODO: G·ªçi API th·ª±c t·∫ø
                // const response = await authFetch(`/api/bookings/validate/${code}`);
                
                // DEMO: Fake data
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Demo: BK123456 l√† v√© h·ª£p l·ªá
                if (code === 'BK123456') {
                    showValidTicket({
                        code: 'BK123456',
                        movie: 'Avengers: Endgame',
                        date: '21/12/2025',
                        time: '19:30',
                        cinema: 'CGV Vincom Ba Trieu - Ph√≤ng 05',
                        seats: 'H5, H6, H7',
                        customer: 'Nguy·ªÖn VƒÉn A - 0901234567'
                    });
                } else {
                    showInvalidTicket('Kh√¥ng t√¨m th·∫•y v√© v·ªõi m√£ n√†y');
                }
                
            } catch (error) {
                showInvalidTicket(error.message || 'L·ªói ki·ªÉm tra v√©');
            }
        }
        
        function showValidTicket(data) {
            const resultSection = document.getElementById('resultSection');
            const ticketCard = document.getElementById('ticketCard');
            const ticketHeader = document.getElementById('ticketHeader');
            
            ticketCard.className = 'ticket-card valid';
            ticketHeader.className = 'ticket-header valid';
            
            document.getElementById('statusIcon').textContent = '‚úÖ';
            document.getElementById('statusTitle').textContent = 'V√© h·ª£p l·ªá';
            document.getElementById('statusDesc').textContent = 'C√≥ th·ªÉ cho kh√°ch v√†o r·∫°p';
            
            document.getElementById('movieName').textContent = data.movie;
            document.getElementById('showDate').textContent = data.date;
            document.getElementById('showTime').textContent = data.time;
            document.getElementById('cinema').textContent = data.cinema;
            document.getElementById('seats').textContent = data.seats;
            document.getElementById('customer').textContent = data.customer;
            
            document.getElementById('ticketActions').innerHTML = `
                <button class="btn btn-success" onclick="confirmCheckin('${data.code}')">
                    ‚úÖ X√°c Nh·∫≠n Check-in
                </button>
                <button class="btn btn-outline" onclick="clearResult()">
                    ‚Ü©Ô∏è Qu√©t V√© Kh√°c
                </button>
            `;
            
            resultSection.classList.add('show');
        }
        
        function showInvalidTicket(message) {
            const resultSection = document.getElementById('resultSection');
            const ticketCard = document.getElementById('ticketCard');
            const ticketHeader = document.getElementById('ticketHeader');
            
            ticketCard.className = 'ticket-card invalid';
            ticketHeader.className = 'ticket-header invalid';
            
            document.getElementById('statusIcon').textContent = '‚ùå';
            document.getElementById('statusTitle').textContent = 'V√© kh√¥ng h·ª£p l·ªá';
            document.getElementById('statusDesc').textContent = message;
            
            document.getElementById('movieName').textContent = '--';
            document.getElementById('showDate').textContent = '--';
            document.getElementById('showTime').textContent = '--';
            document.getElementById('cinema').textContent = '--';
            document.getElementById('seats').textContent = '--';
            document.getElementById('customer').textContent = '--';
            
            document.getElementById('ticketActions').innerHTML = `
                <button class="btn btn-outline" onclick="clearResult()">
                    ‚Ü©Ô∏è Qu√©t V√© Kh√°c
                </button>
            `;
            
            resultSection.classList.add('show');
        }
        
        async function confirmCheckin(code) {
            try {
                // TODO: G·ªçi API check-in th·ª±c t·∫ø
                // await authFetch(`/api/bookings/${code}/checkin`, { method: 'POST' });
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                alert('‚úÖ Check-in th√†nh c√¥ng!');
                addToHistory(code, true);
                clearResult();
                
            } catch (error) {
                alert('‚ùå L·ªói: ' + (error.message || 'Kh√¥ng th·ªÉ check-in'));
            }
        }
        
        function clearResult() {
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('bookingCode').value = '';
            document.getElementById('bookingCode').focus();
        }
        
        const history = [];
        function addToHistory(code, success) {
            history.unshift({
                code,
                success,
                time: new Date().toLocaleTimeString('vi-VN')
            });
            
            const html = history.slice(0, 10).map(item => `
                <div class="history-item">
                    <div class="history-icon ${item.success ? 'success' : 'error'}">
                        ${item.success ? '‚úÖ' : '‚ùå'}
                    </div>
                    <div class="history-info">
                        <div class="history-code">${item.code}</div>
                        <div class="history-time">${item.time}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('historyList').innerHTML = html;
        }
        
        function handleLogout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                logout();
                window.location.href = '../login.html';
            }
        }
    </script>
</body>
</html>
