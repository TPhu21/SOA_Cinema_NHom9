<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMax - ƒê·∫∑t V√© Xem Phim</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #e50914;
            --primary-dark: #b2070f;
            --secondary: #221f1f;
            --light: #f5f5f1;
            --dark: #000000;
            --gray: #757575;
            --success: #46d369;
            --warning: #ffa500;
        }

        body {
            background-color: var(--secondary);
            color: var(--light);
            line-height: 1.6;
        }

        header {
            background-color: var(--dark);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
        }

        .logo span {
            color: var(--light);
        }

        .nav-menu {
            display: flex;
            list-style: none;
        }

        .nav-menu li {
            margin-left: 1.5rem;
        }

        .nav-menu a {
            color: var(--light);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-menu a:hover {
            color: var(--primary);
        }

        .user-actions {
            display: flex;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--light);
            color: var(--light);
            margin-right: 10px;
        }

        .btn-outline:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .booking-process {
            display: flex;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .process-step {
            flex: 1;
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        .process-step.active {
            background: var(--primary);
        }

        .process-step.completed {
            background: var(--success);
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            line-height: 30px;
            margin-bottom: 0.5rem;
        }

        .process-step.active .step-number,
        .process-step.completed .step-number {
            background: white;
            color: var(--dark);
        }

        .movie-selection {
            display: none; 
        }

        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .movie-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .movie-card.selected {
            border-color: var(--primary);
        }

        .movie-poster {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .movie-info {
            padding: 1rem;
        }

        .movie-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .movie-meta {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 0.8rem;
        }

        .rating {
            color: gold;
            font-weight: bold;
        }

        .selection-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: none;
        }

        .selection-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cinema-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .cinema-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            border: 2px solid transparent;
        }

        .cinema-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .cinema-item.selected {
            border-color: var(--primary);
            background: rgba(229, 9, 20, 0.1);
        }

        .time-slots {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .time-slot {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .time-slot:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .time-slot.selected {
            background: var(--primary);
            border-color: var(--primary);
        }

        .time-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
        }
        .seat-selection {
            text-align: center;
        }

        .screen {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.1) 100%);
            padding: 1rem;
            margin: 2rem 0;
            border-radius: 4px;
            font-weight: bold;
            color: var(--light);
        }

        .seats-container {
            display: inline-block;
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 8px;
        }

        .seat-row {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .booking-summary {
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .payment-method {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }

        .payment-method:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .payment-method.selected {
            border-color: var(--primary);
            background: rgba(229, 9, 20, 0.1);
        }

        .payment-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn-large {
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3aa955;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--secondary);
            padding: 3rem;
            border-radius: 8px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .success-icon {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 1rem;
        }

        footer {
            background-color: var(--dark);
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .footer-links a {
            color: var(--gray);
            text-decoration: none;
            margin: 0 1rem;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--light);
        }

        .copyright {
            color: var(--gray);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav-menu {
                margin-top: 1rem;
                flex-wrap: wrap;
            }

            .nav-menu li {
                margin: 0.5rem 1rem 0.5rem 0;
            }

            .user-actions {
                margin-top: 1rem;
            }

            .movie-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }

            .cinema-list {
                grid-template-columns: 1fr;
            }

            .navigation-buttons {
                flex-direction: column;
                gap: 1rem;
            }

            .btn-large {
                width: 100%;
            }

            .process-step {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

        }
        /* Container v·∫Ω gh·∫ø */
        #seatsLayout {
            display: grid;
            grid-auto-rows: 40px;    /* chi·ªÅu cao m·ªói h√†ng */
            gap: 8px;
            justify-content: center;
        }

        /* Base cho gh·∫ø */
        .seat {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #fff;
            transition: all 0.2s;
            position: relative;
        }

        /* Tooltip gi√° */
        .seat:not(.occupied):not(.locked):hover::after {
            content: attr(data-price);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
        }

        /* GH·∫æ VIP */
        .seat.vip {
            border: 2px solid #f1c40f;
            color: #f1c40f;
            background: rgba(241, 196, 15, 0.1);
        }

        /* GH·∫æ ƒê√îI ‚Äì chi·∫øm 2 c·ªôt + m√†u h·ªìng */
        .seat.couple {
            background: #e91e63;
            color: #fff;
            grid-column: span 2;
            width: 100%;/* 2 c·ªôt */
        }

        /* Tr·∫°ng th√°i gh·∫ø */
        /* Tr·∫°ng th√°i gh·∫ø: ƒê√É ƒê·∫∂T + ƒê√É KH√ìA ƒë·ªÅu ƒë·ªè */
        .seat.occupied,
        .seat.locked {
            background: #e50914 !important;   /* ƒë·ªè */
            color: #fff !important;
            cursor: not-allowed;
            opacity: 1;
            border: none;
        }

        .seat.selected {
            background: #46d369 !important;
            color: #fff !important;
            border: none !important;
            box-shadow: 0 0 10px #46d369;
        }

        /* Legend */
        .seat.legend {
            width: 25px;
            height: 25px;
            font-size: 0;
            cursor: default;
            grid-column: auto;          /* kh√¥ng span 2 c·ªôt */
        }


        /* Thanh cu·ªôn ngang cho danh s√°ch ng√†y */
        .date-list {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .date-item {
            min-width: 80px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .date-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .date-item.selected {
            border-color: var(--primary);
            background: rgba(229, 9, 20, 0.1);
            font-weight: bold;
        }

        .date-item span {
            display: block;
            font-size: 0.9rem;
        }

        .date-item .day-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="#" class="logo">Cine<span>Max</span></a>
            
            <ul class="nav-menu">
                <li><a href="TrangChu.html">Trang Ch·ªß</a></li>
                <li><a href="Phim.html">Phim</a></li>
                <li><a href="RapChieu.html">R·∫°p Chi·∫øu</a></li>
                <li><a href="KhuyenMai.html">Khuy·∫øn M√£i</a></li>
                <li><a href="LienHe.html">Li√™n H·ªá</a></li>
                <li><a href="DangKyThanhVien.html">ƒêƒÉng k√Ω h·ªôi vi√™n</a></li>
            </ul>
            
            <div class="user-actions">
                <button class="btn btn-outline" id="loginBtn" onclick="redirectToTaiKhoan()">ƒêƒÉng Nh·∫≠p</button>
                <button class="btn btn-primary" id="registerBtn" onclick="redirectToTaiKhoan()">ƒêƒÉng K√Ω</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="booking-process">
            <div class="process-step active" id="step1">
                <div class="step-number">1</div>
                <div>Ch·ªçn R·∫°p & Su·∫•t Chi·∫øu</div>
            </div>
            <div class="process-step" id="step2">
                <div class="step-number">2</div>
                <div>Ch·ªçn Gh·∫ø</div>
            </div>
            <div class="process-step" id="step3">
                <div class="step-number">3</div>
                <div>Thanh To√°n</div>
            </div>
        </div>

        <section class="selection-section active" id="cinemaSelection">
            <h2>Ch·ªçn R·∫°p & Su·∫•t Chi·∫øu</h2>
            <p>Ch·ªçn r·∫°p chi·∫øu v√† th·ªùi gian ph√π h·ª£p v·ªõi b·∫°n</p>
            
            <h3 style="margin-top: 2rem;">Ch·ªçn R·∫°p Chi·∫øu</h3>
            <div class="cinema-list" id="cinemaList">
            </div>
            
            <h3 style="margin-top: 2rem;">Ch·ªçn Ng√†y Chi·∫øu</h3>
            <div class="date-list" id="dateList">
            </div>

            <h3 style="margin-top: 1rem;">Ch·ªçn Su·∫•t Chi·∫øu</h3>
            <div class="time-slots" id="timeSlots">

            </div>
            
            <div class="navigation-buttons">
                <div></div> 
                <button class="btn btn-primary btn-large" onclick="nextToSeatSelection()">Ti·∫øp Theo</button>
            </div>
        </section>

        <section class="selection-section" id="seatSelection">
            <h2>Ch·ªçn Gh·∫ø Ng·ªìi</h2>
            <p>Ch·ªçn gh·∫ø ng·ªìi ∆∞a th√≠ch c·ªßa b·∫°n</p>
            
            <div class="seat-selection">
                <div class="screen">M√ÄN H√åNH CH√çNH</div>
                
                <div class="seats-container">
                    <div id="seatsLayout"></div>
                </div>
                    
                    <div class="seat-legend">
                        <div class="legend-item">
                            <div class="seat legend"></div>
                            <span>Gh·∫ø th∆∞·ªùng</span>
                        </div>
                        <div class="legend-item">
                            <div class="seat legend vip"></div>
                            <span>Gh·∫ø VIP</span>
                        </div>
                        <div class="legend-item">
                            <div class="seat legend couple"></div>
                            <span>Gh·∫ø ƒë√¥i</span>
                        </div>

                        <div class="legend-item">
                            <div class="seat legend selected"></div>
                            <span>ƒê√£ ch·ªçn</span>
                        </div>
                        <div class="legend-item">
                            <div class="seat legend occupied"></div>
                            <span>ƒê√£ kho√°</span>
                        </div>
                    </div>
                </div>

            <div class="navigation-buttons">
                <button class="btn btn-outline btn-large" onclick="goBack(1)">Quay L·∫°i</button>
                <button class="btn btn-primary btn-large" onclick="handleSeatSelectionNext()">Ti·∫øp Theo</button>
            </div>
        </section>

        <section class="selection-section" id="paymentSection">
            <h2>Thanh To√°n</h2>
            <p>X√°c nh·∫≠n th√¥ng tin v√† ho√†n t·∫•t thanh to√°n</p>
            
            <div class="booking-summary">
                <h3>Th√¥ng Tin ƒê·∫∑t V√©</h3>
                <div class="summary-item">
                    <span>Phim:</span>
                    <span id="summaryMovie">Ch∆∞a ch·ªçn</span>
                </div>
                <div class="summary-item">
                    <span>R·∫°p:</span>
                    <span id="summaryCinema">Ch∆∞a ch·ªçn</span>
                </div>
                <div class="summary-item">
                    <span>Su·∫•t chi·∫øu:</span>
                    <span id="summaryTime">Ch∆∞a ch·ªçn</span>
                </div>
                <div class="summary-item">
                    <span>Gh·∫ø:</span>
                    <span id="summarySeats">Ch∆∞a ch·ªçn</span>
                </div>
                <div class="summary-item">
                    <span>S·ªë l∆∞·ª£ng:</span>
                    <span id="summaryQuantity">0 v√©</span>
                </div>
                <div class="summary-item summary-total">
                    <span>T·ªïng ti·ªÅn:</span>
                    <span id="summaryTotal">0 ƒë</span>
                </div>
            </div>
            
            <h3>Ch·ªçn Ph∆∞∆°ng Th·ª©c Thanh To√°n</h3>
            <div class="payment-methods">
                <div class="payment-method" data-method="momo">
                    <div class="payment-icon"></div>
                    <div>V√≠ MoMo</div>
                </div>
                <div class="payment-method" data-method="zalopay">
                    <div class="payment-icon"></div>
                    <div>ZaloPay</div>
                </div>
                <div class="payment-method" data-method="vnpay">
                    <div class="payment-icon"></div>
                    <div>VNPay</div>
                </div>
                <div class="payment-method" data-method="banking">
                    <div class="payment-icon"></div>
                    <div>Chuy·ªÉn Kho·∫£n</div>
                </div>
                <div class="payment-method" data-method="cash">
                    <div class="payment-icon"></div>
                    <div>Ti·ªÅn M·∫∑t</div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn btn-outline btn-large" onclick="goToStep(2)">Quay L·∫°i</button>
                <button class="btn btn-success btn-large" onclick="completeBooking()">Ho√†n T·∫•t ƒê·∫∑t V√©</button>
            </div>
        </section>
    </main>
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="success-icon">‚úÖ</div>
            <h2>ƒê·∫∑t V√© Th√†nh C√¥ng!</h2>
            <p id="successMessage">C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t v√©. Th√¥ng tin v√© ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n.</p>
            <div style="margin-top: 2rem;">
                <button class="btn btn-primary" onclick="closeModal()">ƒê√≥ng</button>
                <button class="btn btn-outline" onclick="printTicket()">In V√©</button>
            </div>
        </div>
    </div>


    <footer>
        <div class="footer-content">
            <div class="footer-links">
                <a href="#">Gi·ªõi thi·ªáu</a>
                <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
                <a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
                <a href="#">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a>
                <a href="#">Li√™n h·ªá</a>
            </div>
            <p class="copyright">¬© 2025 CineMax. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        </div>
    </footer>

    <script src="../shared/js/api-client.js"></script>
    <script src="../shared/js/auth.js"></script>
    <script src="config.js"></script>


    <script>
        // --- BI·∫æN TO√ÄN C·ª§C ---
        let bookingData = {
            movie: { id: null, title: "" },
            cinema: null,
            showTime: null,
            seats: [],
            totalPrice: 0,
            paymentMethod: null
        };

        // ng√†y ƒëang ch·ªçn, format: 'YYYY-MM-DD'
        let selectedDate = "";
        let seatPriceMap = {};
        let pollingInterval;
        let currentOrderId = null;

        // --- H√ÄM TI·ªÜN √çCH: L·∫§Y NG√ÄY H√îM NAY THEO LOCAL (KH√îNG D√ôNG toISOString UTC) ---
        function getTodayString() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;   // v√≠ d·ª•: 2025-12-06
        }

        // --- KH·ªûI T·∫†O ---
        const urlParams = new URLSearchParams(window.location.search);
        const movieIdFromUrl = urlParams.get('movieId');
        const titleFromUrl = urlParams.get('title');

        document.addEventListener('DOMContentLoaded', () => {
            initBooking();
            setupPaymentMethods();
            restoreBookingDraft(); // ‚úÖ th√™m d√≤ng n√†y
        });


        function initBooking() {
            if (!movieIdFromUrl) {
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y ID phim.');
                return;
            }
            bookingData.movie.id = Number(movieIdFromUrl);
            bookingData.movie.title = decodeURIComponent(titleFromUrl || "");

            // l√∫c m·ªõi v√†o trang: ch·ªâ load r·∫°p
            loadCinemas();
            updateSummary();
        }
        function getAuthToken() {
            return (
                localStorage.getItem("cinemax_token") ||
                localStorage.getItem("token") ||
                sessionStorage.getItem("token")
            );
        }

        function getUserFromStorage() {
            const u =
                localStorage.getItem("cinemax_user") ||
                localStorage.getItem("user") ||
                sessionStorage.getItem("user");
            try { return u ? JSON.parse(u) : null; } catch { return null; }
        }

        // decode JWT payload (kh√¥ng verify, ch·ªâ ƒë·ªçc)
        function decodeJwtPayload(token) {
            try {
                const payload = token.split(".")[1];
                const json = atob(payload.replace(/-/g, "+").replace(/_/g, "/"));
                return JSON.parse(json);
            } catch {
                return null;
            }
        }
        function mapPaymentMethod(uiMethod) {
            if (!uiMethod) return null;

            const v = String(uiMethod).toLowerCase();

            // UI c·ªßa b·∫°n c√≥ th·ªÉ l√†: cash | momo | vnpay | zalopay | vietqr
            // ho·∫∑c c√≥ th·ªÉ ƒëang d√πng banking/transfer... th√¨ map v·ªÅ vietqr (tu·ª≥ b·∫°n)
            if (v === "cash") return "cash";
            if (v === "momo") return "momo";
            if (v === "vnpay") return "vnpay";
            if (v === "zalopay") return "zalopay";
            if (v === "vietqr") return "vietqr";

            // n·∫øu UI d√πng banking/transfer th√¨ b·∫°n ch·ªçn map nh∆∞ sau:
            if (v === "banking" || v === "transfer") return "vietqr";

            return null;
        }

        /**
         * Tr·∫£ v·ªÅ userId (∆∞u ti√™n l·∫•y t·ª´ localStorage user, fallback ƒë·ªçc t·ª´ JWT).
         * Node c·ªßa b·∫°n ƒëang c√≥ payload { id: 3, email: ..., role: ... } nh∆∞ screenshot.
         */
        function getUserIdFromAuth() {
            const user = getUserFromStorage();
            if (user?.id) return String(user.id);

            const token = getAuthToken();
            if (!token) return null;

            const payload = decodeJwtPayload(token);
            return payload?.id ? String(payload.id) : null; // ho·∫∑c payload?.sub n·∫øu b·∫°n d√πng subject
        }

        // --- T·∫†O THANH CH·ªåN NG√ÄY D·ª∞A TR√äN selectedDate ---
        function generateDateTabs() {
            console.log("Generating date tabs...");
            const dateListEl = document.getElementById('dateList');
            if (!dateListEl) return;

            dateListEl.innerHTML = '';

            // n·∫øu ch∆∞a c√≥ selectedDate th√¨ d√πng h√¥m nay
            if (!selectedDate) {
                selectedDate = getTodayString();
            }

            const startDate = new Date(selectedDate);
            if (isNaN(startDate.getTime())) {
                console.warn("selectedDate invalid:", selectedDate);
                return;
            }

            const days = ['CN', 'Th 2', 'Th 3', 'Th 4', 'Th 5', 'Th 6', 'Th 7'];
            const todayStr = getTodayString();

            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                const apiDate = date.toISOString().split('T')[0]; // YYYY-MM-DD

                // label ng√†y
                let dayName;
                if (apiDate === todayStr) {
                    dayName = "H√¥m nay";
                } else {
                    dayName = days[date.getDay()];
                }
                const dayNumber = date.getDate() + "/" + (date.getMonth() + 1);

                const div = document.createElement('div');
                div.className = 'date-item';
                if (apiDate === selectedDate) {
                    div.classList.add('selected');
                }

                div.innerHTML = `<span>${dayName}</span><div class="day-number">${dayNumber}</div>`;

                // click ch·ªçn ng√†y
                div.addEventListener('click', () => {
                    console.log("Ng√†y ƒë∆∞·ª£c ch·ªçn:", apiDate);
                    document.querySelectorAll('.date-item').forEach(d => d.classList.remove('selected'));
                    div.classList.add('selected');

                    selectedDate = apiDate;
                    console.log("selectedDate = ", selectedDate);

                    // ƒë√£ ch·ªçn r·∫°p r·ªìi th√¨ load l·∫°i su·∫•t chi·∫øu theo ng√†y m·ªõi
                    if (bookingData.cinema && bookingData.cinema.id) {
                        loadTimeSlots(bookingData.cinema.id);
                    }
                });

                dateListEl.appendChild(div);
            }
        }

        // --- 1. T·∫¢I DANH S√ÅCH R·∫†P ---
        async function loadCinemas() {
            const cinemaList = document.getElementById('cinemaList');
            cinemaList.innerHTML = '<p>ƒêang ki·ªÉm tra r·∫°p chi·∫øu...</p>';
            const movieId = bookingData.movie.id;

            try {
                const res = await fetch(`${API_BASE_URL}/showtimes/cinemas-by-movie/${movieId}`);
                if (!res.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch r·∫°p.');

                const cinemasFromBE = await res.json();

                const cinemas = cinemasFromBE.map(c => ({
                    id: c.cinemaId,
                    name: c.cinemaName,
                    location: c.cinemaAddress
                }));

                cinemaList.innerHTML = '';
                if (cinemas.length === 0) {
                    cinemaList.innerHTML = '<p>Ch∆∞a c√≥ r·∫°p n√†o chi·∫øu phim n√†y.</p>';
                    return;
                }

                cinemas.forEach(cinema => {
                    const div = document.createElement('div');
                    div.className = 'cinema-item';
                    div.innerHTML = `<h3>${cinema.name}</h3><p>${cinema.location}</p>`;

                    div.addEventListener('click', function () {
                        document.querySelectorAll('.cinema-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');

                        bookingData.cinema = cinema;

                        // Reset khi ƒë·ªïi r·∫°p
                        bookingData.showTime = null;
                        bookingData.seats = [];
                        seatPriceMap = {};
                        document.getElementById('timeSlots').innerHTML = '';
                        document.getElementById('seatsLayout').innerHTML = '';
                        document.getElementById('dateList').innerHTML = '';

                        // ‚úÖ m·∫∑c ƒë·ªãnh ch·ªçn NG√ÄY H√îM NAY (local) khi ch·ªçn r·∫°p
                        selectedDate = getTodayString();
                        console.log("Default selectedDate (today) =", selectedDate);

                        // v·∫Ω thanh ng√†y b·∫Øt ƒë·∫ßu t·ª´ h√¥m nay
                        generateDateTabs();

                        // g·ªçi su·∫•t chi·∫øu cho r·∫°p + ng√†y h√¥m nay
                        loadTimeSlots(cinema.id);

                        updateSummary();
                    });

                    cinemaList.appendChild(div);
                });

            } catch (err) {
                console.error('L·ªói loadCinemas:', err);
                cinemaList.innerHTML = '<p>L·ªói k·∫øt n·ªëi server.</p>';
            }
        }

        // --- 2. T·∫¢I SU·∫§T CHI·∫æU THEO R·∫†P + NG√ÄY ƒêANG CH·ªåN ---
        async function loadTimeSlots(cinemaId) {
            const timeSlots = document.getElementById('timeSlots');
            timeSlots.innerHTML = '<p>ƒêang t·∫£i l·ªãch...</p>';
            const movieId = bookingData.movie.id;

            try {
                let url = `${API_BASE_URL}/showtimes/details?movieId=${movieId}&cinemaId=${cinemaId}`;

                // lu√¥n g·ª≠i date n·∫øu c√≥ selectedDate
                if (selectedDate) {
                    url += `&date=${selectedDate}`;
                }

                console.log("Call showtimes URL:", url);

                const response = await fetch(url);
                if (!response.ok) throw new Error('L·ªói t·∫£i su·∫•t chi·∫øu');

                const showtimes = await response.json();
                timeSlots.innerHTML = '';

                if (!showtimes || showtimes.length === 0) {
                    timeSlots.innerHTML = "<p>H·∫øt su·∫•t chi·∫øu cho ng√†y n√†y.</p>";
                    return;
                }

                showtimes.forEach(show => {
                    const btn = document.createElement('div');
                    btn.className = 'time-slot';
                    const timeStr = new Date(show.startTime).toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    btn.textContent = timeStr;

                    // CLICK CH·ªåN GI·ªú
                    btn.addEventListener('click', async function () {
                        // Reset giao di·ªán n√∫t ch·ªçn
                        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                        this.classList.add('selected');

                        try {
                            // 1. C·∫¨P NH·∫¨T BI·∫æN TO√ÄN C·ª§C (Quan tr·ªçng!)
                            bookingData.showTime = show;
                            // L·∫•y ID chu·∫©n (∆∞u ti√™n showTimeId, d·ª± ph√≤ng id)
                            bookingData.showTimeId = show.showTimeId || show.id;
                            bookingData.time = timeStr;

                            // Reset gh·∫ø c≈©
                            bookingData.seats = [];
                            seatPriceMap = {};

                            // Ki·ªÉm tra ID tr∆∞·ªõc khi g·ªçi
                            if (!bookingData.showTimeId) {
                                throw new Error("D·ªØ li·ªáu su·∫•t chi·∫øu b·ªã thi·∫øu ID!");
                            }

                            // 2. T·∫£i gh·∫ø (N·∫øu API l·ªói 500, n√≥ s·∫Ω nh·∫£y xu·ªëng catch thay v√¨ treo)
                            await loadAndRenderSeats(bookingData.showTimeId);

                            updateSummary();

                            // 3. Chuy·ªÉn b∆∞·ªõc
                            goToStep(2);

                        } catch (e) {
                            console.error("L·ªói khi ch·ªçn su·∫•t chi·∫øu:", e);
                            alert("Kh√¥ng th·ªÉ t·∫£i s∆° ƒë·ªì gh·∫ø: " + e.message);
                            // D√π l·ªói c≈©ng kh√¥ng chuy·ªÉn trang ƒë·ªÉ user bi·∫øt
                        }
                    });

                    timeSlots.appendChild(btn);
                });

            } catch (error) {
                console.error("L·ªói t·∫£i su·∫•t chi·∫øu:", error);
                timeSlots.innerHTML = "<p>L·ªói t·∫£i danh s√°ch su·∫•t chi·∫øu.</p>";
            }
        }


        // --- 3. T·∫¢I V√Ä V·∫º GH·∫æ --- (B·∫¢N ƒê√É FIX & DEBUG SEATTYPE)
        // --- 3. T·∫¢I V√Ä V·∫º GH·∫æ (FIX ƒê·ªåC SNAKE_CASE / CAMELCASE & STYLE THEO SEATTYPE + STATUS) ---

        async function loadAndRenderSeats(showId) {
            if (!showId || showId === 'undefined') {
                console.error("ID su·∫•t chi·∫øu kh√¥ng h·ª£p l·ªá:", showId);
                return;
            }

            const layoutEl = document.getElementById('seatsLayout');
            layoutEl.style.minHeight = "300px";

            try {
                // Get token from localStorage if available
                const token = localStorage.getItem('cinemax_token') || localStorage.getItem('token') || sessionStorage.getItem('token');
                const headers = {};
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }

                const res = await fetch(`${API_BASE_URL}/bookings/seat-map?showTimeId=${showId}`, {
                    headers: headers
                });
                if (!res.ok) throw new Error("L·ªói t·∫£i gh·∫ø: " + res.status);

                const data = await res.json();
                const seats = data.seats || [];
                const colCount = data.colCount || 10;

                if (!seats.length) {
                    layoutEl.innerHTML = '<p style="color:white;text-align:center">Kh√¥ng c√≥ d·ªØ li·ªáu gh·∫ø.</p>';
                    return;
                }

                // S·∫Øp x·∫øp theo rowLabel + seatNumber (A1, A2, ..., B1, B2, ...)
                seats.sort((a, b) => {
                    const rowCmp = a.rowLabel.localeCompare(b.rowLabel);
                    if (rowCmp !== 0) return rowCmp;
                    return (a.seatNumber || 0) - (b.seatNumber || 0);
                });

                // Gom gh·∫ø theo t·ª´ng h√†ng
                const rowsMap = new Map();
                seats.forEach(s => {
                    if (!rowsMap.has(s.rowLabel)) rowsMap.set(s.rowLabel, []);
                    rowsMap.get(s.rowLabel).push(s);
                });

                layoutEl.innerHTML = '';
                layoutEl.style.display = 'grid';
                layoutEl.style.gridTemplateColumns = `repeat(${colCount}, 40px)`;
                layoutEl.style.gridAutoRows = '40px';
                layoutEl.style.gap = '8px';
                layoutEl.style.justifyContent = 'center';

                seatPriceMap = {};

                // Duy·ªát theo h√†ng A, B, C...
                const sortedRowLabels = Array.from(rowsMap.keys()).sort();
                sortedRowLabels.forEach((rowLabel, rowIndex) => {
                    const rowSeats = rowsMap.get(rowLabel);
                    let displayCol = 1;           // c·ªôt ƒëang v·∫Ω (1..colCount)
                    const gridRow = rowIndex + 1; // v·ªã tr√≠ row trong CSS grid

                    for (let i = 0; i < rowSeats.length; i++) {
                        const seat = rowSeats[i];

                        // N·∫øu l√† gh·∫ø ƒë√¥i v√† gh·∫ø k·∫ø ti·∫øp c√πng lo·∫°i + seatNumber+1 -> g·ªôp th√†nh c·∫∑p
                        if (seat.seatType === 'COUPLE' && i + 1 < rowSeats.length) {
                            const next = rowSeats[i + 1];
                            if (next.seatType === 'COUPLE' && next.seatNumber === seat.seatNumber + 1) {
                                const divCouple = renderCoupleSeat(gridRow, displayCol, seat, next);
                                layoutEl.appendChild(divCouple);
                                displayCol += 2; // chi·∫øm 2 c·ªôt
                                i++;             // b·ªè qua gh·∫ø ti·∫øp theo (ƒë√£ g·ªôp)
                                continue;
                            }
                        }

                        // N·∫øu kh√¥ng ph·∫£i c·∫∑p gh·∫ø ƒë√¥i -> render gh·∫ø ƒë∆°n
                        const divSingle = renderSingleSeat(gridRow, displayCol, seat);
                        layoutEl.appendChild(divSingle);
                        displayCol++;
                    }
                });

            } catch (e) {
                console.error("L·ªói v·∫Ω gh·∫ø:", e);
                layoutEl.innerHTML = '<p style="color:red;text-align:center">L·ªói t·∫£i s∆° ƒë·ªì gh·∫ø.</p>';
            }
        }

        // GH·∫æ TH∆Ø·ªúNG / VIP: chi·∫øm 1 c·ªôt
        // GH·∫æ TH∆Ø·ªúNG / VIP: chi·∫øm 1 c·ªôt
        // GH·∫æ TH∆Ø·ªúNG / VIP: chi·∫øm 1 c·ªôt
        function renderSingleSeat(gridRow, gridCol, s) {
            const div = document.createElement('div');
            div.className = 'seat';
            div.innerText = s.seatCode;

            const price = Number(s.price);
            seatPriceMap[s.seatCode] = price;
            div.setAttribute('data-price', (price / 1000) + 'k');

            div.style.gridRow = gridRow;
            div.style.gridColumn = gridCol;

            // lo·∫°i gh·∫ø
            if (s.seatType === 'VIP')    div.classList.add('vip');
            if (s.seatType === 'COUPLE') div.classList.add('couple'); // ph√≤ng nh·ªè c√≥ th·ªÉ c√≥ gh·∫ø ƒë√¥i l·∫ª

            const isMySelected   = bookingData.seats.includes(s.seatCode);
            const isLockedStatus = ['LOCKED', 'PENDING', 'RESERVED'].includes(s.status);

            // --- tr·∫°ng th√°i ---
            if (s.status === 'BOOKED' || s.status === 'OCCUPIED') {
                // Gh·∫ø ƒë√£ b√°n -> ƒë·ªè, kh√¥ng click
                div.classList.add('occupied');

            } else if (isLockedStatus) {
                // Gh·∫ø ƒëang b·ªã gi·ªØ
                div.dataset.wasLocked = 'true'; // ghi nh·ªõ: ƒë√£ t·ª´ng b·ªã BE lock

                if (isMySelected) {
                    // üëâ gh·∫ø do CH√çNH M√åNH gi·ªØ:
                    //     - hi·ªÉn th·ªã xanh (selected)
                    //     - v·∫´n cho click ƒë·ªÉ b·ªè ch·ªçn -> releaseSeats
                    div.classList.add('selected');
                    addClickEvent(div, [s.seatCode]);
                } else {
                    // üëâ gh·∫ø ng∆∞·ªùi kh√°c gi·ªØ:
                    div.classList.add('locked'); // ƒë·ªè, kh√¥ng click
                }

            } else {
                // AVAILABLE tr√™n BE
                addClickEvent(div, [s.seatCode]);
                if (isMySelected) {
                    // tr∆∞·ªùng h·ª£p FE v·∫´n nh·ªõ gh·∫ø ƒë√£ ch·ªçn (ch∆∞a g·ªçi hold)
                    div.classList.add('selected');
                }
            }

            return div;
        }

        // GH·∫æ ƒê√îI: 1 block cho 2 seatCode, chi·∫øm 2 c·ªôt
        function renderCoupleSeat(gridRow, gridCol, s1, s2) {
            const div = document.createElement('div');
            div.className = 'seat couple';
            div.innerText = `${s1.seatCode}-${s2.seatCode}`;

            // gi√° t·ª´ng gh·∫ø
            const price1 = Number(s1.price);
            const price2 = Number(s2.price);
            seatPriceMap[s1.seatCode] = price1;
            seatPriceMap[s2.seatCode] = price2;

            // tooltip t·ªïng gi√° 2 gh·∫ø
            div.setAttribute('data-price', ((price1 + price2) / 1000) + 'k');

            // chi·∫øm 2 c·ªôt
            div.style.gridRow = gridRow;
            div.style.gridColumn = `${gridCol} / span 2`;

            const codes = [s1.seatCode, s2.seatCode];
            const isMySelectedCouple = codes.every(code => bookingData.seats.includes(code));

            const isBooked =
                s1.status === 'BOOKED' || s1.status === 'OCCUPIED' ||
                s2.status === 'BOOKED' || s2.status === 'OCCUPIED';

            const isLockedStatus =
                ['LOCKED', 'PENDING', 'RESERVED'].includes(s1.status) ||
                ['LOCKED', 'PENDING', 'RESERVED'].includes(s2.status);

            if (isBooked) {
                // c·∫∑p gh·∫ø ƒë√£ b√°n -> ƒë·ªè
                div.classList.add('occupied');

            } else if (isLockedStatus) {
                div.dataset.wasLocked = 'true';

                if (isMySelectedCouple) {
                    // üëâ gh·∫ø ƒë√¥i do CH√çNH M√åNH gi·ªØ:
                    //     - xanh
                    //     - click b·ªè ch·ªçn -> releaseSeats
                    div.classList.add('selected');
                    addClickEvent(div, codes);
                } else {
                    // üëâ gh·∫ø ƒë√¥i ng∆∞·ªùi kh√°c gi·ªØ
                    div.classList.add('locked');
                }

            } else {
                // AVAILABLE
                addClickEvent(div, codes);
                if (isMySelectedCouple) {
                    div.classList.add('selected');
                }
            }

            return div;
        }


        // G·ªçi BE ƒë·ªÉ tr·∫£ gh·∫ø v·ªÅ AVAILABLE khi ng∆∞·ªùi d√πng b·ªè ch·ªçn
        async function releaseSeats(showId, seatCodes) {
            try {
                const userId = getUserIdFromAuth();
                if (!userId) return;

                await apiFetch("/bookings/release", {
                    method: "POST",
                    body: JSON.stringify({ showId, userId, seats: seatCodes })
                });
            } catch (e) {
                console.error("L·ªói release gh·∫ø:", e);
            }
        }


        // Click handler: codes l√† m·∫£ng (1 gh·∫ø th∆∞·ªùng, 2 gh·∫ø ƒë√¥i)
        function addClickEvent(div, seatCodes) {
            div.addEventListener('click', async () => {
                // gh·∫ø ƒë√£ b√°n ho·∫∑c ƒëang kh√≥a (kh√¥ng ph·∫£i c·ªßa m√¨nh) th√¨ kh√¥ng cho click
                if (div.classList.contains('occupied') || div.classList.contains('locked')) return;

                const willSelect = !div.classList.contains('selected');
                div.classList.toggle('selected');

                if (willSelect) {
                    // Th√™m v√†o danh s√°ch gh·∫ø ƒë√£ ch·ªçn
                    seatCodes.forEach(code => {
                        if (!bookingData.seats.includes(code)) {
                            bookingData.seats.push(code);
                        }
                    });
                } else {
                    // B·ªè kh·ªèi danh s√°ch gh·∫ø ƒë√£ ch·ªçn
                    bookingData.seats = bookingData.seats.filter(code => !seatCodes.includes(code));

                    // N·∫øu gh·∫ø n√†y ban ƒë·∫ßu ƒë∆∞·ª£c BE ƒë√°nh d·∫•u l√† LOCKED (m√¨nh ƒëang gi·ªØ)
                    // th√¨ khi b·ªè ch·ªçn ph·∫£i release v·ªÅ AVAILABLE
                    if (div.dataset.wasLocked === 'true') {
                        await releaseSeats(bookingData.showTimeId, seatCodes);
                        div.dataset.wasLocked = 'false';
                    }
                }

                updateSummary();
            });
        }




        // --- C√ÅC H√ÄM TI·ªÜN √çCH KH√ÅC (gi·ªØ nguy√™n logic c≈©) ---
        function updateSummary() {
            if (bookingData.movie) document.getElementById('summaryMovie').textContent = bookingData.movie.title;
            if (bookingData.cinema) document.getElementById('summaryCinema').textContent = bookingData.cinema.name;
            if (bookingData.time) document.getElementById('summaryTime').textContent = bookingData.time;

            if (bookingData.seats.length > 0) {
                document.getElementById('summarySeats').textContent = bookingData.seats.join(', ');
                document.getElementById('summaryQuantity').textContent = bookingData.seats.length + ' v√©';
                let total = 0;
                bookingData.seats.forEach(code => { total += (seatPriceMap[code] || 0); });
                bookingData.totalPrice = total;
                document.getElementById('summaryTotal').textContent = total.toLocaleString('vi-VN') + ' ƒë';
            } else {
                document.getElementById('summarySeats').textContent = 'Ch∆∞a ch·ªçn';
                document.getElementById('summaryQuantity').textContent = '0 v√©';
                document.getElementById('summaryTotal').textContent = '0 ƒë';
                bookingData.totalPrice = 0;
            }
        }

        function setupPaymentMethods() {
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function () {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    bookingData.paymentMethod = this.dataset.method;
                });
            });
        }

        async function completeBooking() {
            if (!bookingData.paymentMethod) {
                alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!');
                return;
            }

            const userId = getUserIdFromAuth();
            if (!userId) {
                // ch∆∞a login -> chuy·ªÉn sang trang login kh√°ch h√†ng
                const redirect = encodeURIComponent(window.location.href);
                window.location.href = `TaiKhoan.html?redirect=${redirect}`;
                return;
            }

            const pm = mapPaymentMethod(bookingData.paymentMethod);
            if (!pm) {
                alert("Ph∆∞∆°ng th·ª©c thanh to√°n kh√¥ng h·ª£p l·ªá. (cash | momo | vnpay | zalopay | vietqr)");
                return;
            }

            const createPayload = {
                userId: userId,
                showTimeId: (bookingData.showTime?.id || bookingData.showTime?.showTimeId || bookingData.showTimeId),
                seatCodes: bookingData.seats,
                totalPrice: bookingData.totalPrice,

                // BE c·ªßa b·∫°n validate: cash|vnpay|momo|zalopay|vietqr
                paymentMethod: pm,

                // n·∫øu DTO BE y√™u c·∫ßu expiresAt (·∫£nh b·∫°n g·ª≠i c√≥ l·ªói "expiresAt kh√¥ng ƒë∆∞·ª£c null")
                expiresAt: new Date(Date.now() + 10 * 60 * 1000).toISOString()
            };

            try {
                document.body.style.cursor = 'wait';

                // apiFetch tr·∫£ v·ªÅ JSON lu√¥n
                const bookingResData = await apiFetch("/bookings/pending", {
                    method: "POST",
                    body: JSON.stringify(createPayload)
                });

                // bookingResData ph·∫£i ch·ª©a bookingId (tu·ª≥ BE tr·∫£ g√¨)
                await callPaymentService(
                    bookingResData.bookingId || bookingResData.id,
                    bookingData.totalPrice,
                    pm
                );

            } catch (e) {
                console.error("L·ªói ƒë·∫∑t v√©:", e);
                alert("ƒê·∫∑t v√© th·∫•t b·∫°i: " + e.message);
                loadAndRenderSeats(bookingData.showTimeId);
            } finally {
                document.body.style.cursor = 'default';
            }
        }


        async function callPaymentService(bookingId, totalPrice, paymentMethod) {
            try {
                const token = getAuthToken(); // h√†m b·∫°n ƒë√£ c√≥

                const paymentRes = await fetch(`${API_BASE_URL}/payment/create-payment-link`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    },
                    body: JSON.stringify({
                        orderId: bookingId,
                        amount: totalPrice,
                        orderInfo: `Thanh toan ve #${bookingId}`,
                        providerName: paymentMethod,
                        ipAddr: '127.0.0.1'
                    })
                });

                if (!paymentRes.ok) {
                    const txt = await paymentRes.text();
                    throw new Error(txt || 'Kh√¥ng t·∫°o ƒë∆∞·ª£c link thanh to√°n');
                }

                const paymentData = await paymentRes.json();

                if (paymentMethod === 'cash') {
                    alert('ƒê·∫∑t v√© th√†nh c√¥ng! Vui l√≤ng thanh to√°n t·∫°i qu·∫ßy.');
                } else if (paymentData.paymentLink || paymentData.payUrl) {
                    window.location.href = paymentData.paymentLink || paymentData.payUrl;
                } else if (paymentData.qrDataURL) {
                    openVietQRModal(paymentData);
                }

            } catch (error) {
                console.error("L·ªói g·ªçi PaymentService:", error);
                alert('ƒê√£ x·∫£y ra l·ªói khi t·∫°o thanh to√°n: ' + error.message);
            }
        }


        // --- ƒêI·ªÄU H∆Ø·ªöNG M√ÄN H√åNH (NAVIGATION) ---

        // H√†m chung ƒë·ªÉ chuy·ªÉn ƒë·∫øn m·ªôt b∆∞·ªõc c·ª• th·ªÉ (1, 2, 3)
        // --- NAVIGATION (H√†m ƒëi·ªÅu h∆∞·ªõng chu·∫©n) ---
        function goToStep(stepNumber) {
            try {
                console.log("[goToStep] step =", stepNumber);

                // Validation ch·ªâ cho step 2
                if (stepNumber === 2) {
                    if (!bookingData.cinema || !bookingData.showTimeId) {
                        alert('Vui l√≤ng ch·ªçn r·∫°p v√† su·∫•t chi·∫øu!');
                        return;
                    }
                    loadAndRenderSeats(bookingData.showTimeId);
                }

                // ·∫®n t·∫•t c·∫£ section
                document.querySelectorAll('.selection-section').forEach(s => s.classList.remove('active'));

                const map = { 1: 'cinemaSelection', 2: 'seatSelection', 3: 'paymentSection' };
                const targetId = map[stepNumber];
                const targetEl = document.getElementById(targetId);

                if (!targetEl) {
                    console.error("[goToStep] KH√îNG T√åM TH·∫§Y section id =", targetId);
                    return;
                }

                targetEl.classList.add('active');

                // Update header steps
                for (let i = 1; i <= 3; i++) {
                    const el = document.getElementById('step' + i);
                    if (!el) {
                        console.warn("[goToStep] thi·∫øu #step" + i);
                        continue;
                    }
                    el.classList.remove('active', 'completed');
                    if (i < stepNumber) el.classList.add('completed');
                    if (i === stepNumber) el.classList.add('active');
                }

                // Debug hi·ªÉn th·ªã th·∫≠t s·ª±
                console.log("[goToStep] payment active?",
                    document.getElementById("paymentSection")?.classList.contains("active"),
                    "display=",
                    getComputedStyle(document.getElementById("paymentSection")).display
                );

                window.scrollTo(0, 0);
            } catch (e) {
                console.error("[goToStep] ERROR:", e);
            }
        }

        // N√∫t "Ti·∫øp theo" ·ªü m√†n 2 (Ch·ªçn Gh·∫ø -> Thanh To√°n)
        // H√†m n√†y ƒê√É BAO G·ªíM logic gi·ªØ gh·∫ø (/hold)
        function getCustomerToken() {
            return (
                localStorage.getItem('cinemax_token') ||
                localStorage.getItem('token') ||
                sessionStorage.getItem('token')
            );
        }

        // L∆∞u tr·∫°ng th√°i ƒë·∫∑t v√© ƒë·ªÉ quay l·∫°i kh√¥ng m·∫•t d·ªØ li·ªáu
        function saveBookingDraft() {
            try {
                const draft = {
                    bookingData,
                    selectedDate,
                    seatPriceMap
                };
                sessionStorage.setItem('cinemax_booking_draft', JSON.stringify(draft));
            } catch (e) {}
        }

        // N·∫øu t·ª´ trang login quay l·∫°i th√¨ kh√¥i ph·ª•c d·ªØ li·ªáu
        function restoreBookingDraft() {
            try {
                const raw = sessionStorage.getItem('cinemax_booking_draft');
                if (!raw) return;
                const draft = JSON.parse(raw);

                if (draft.bookingData) bookingData = draft.bookingData;
                if (draft.selectedDate) selectedDate = draft.selectedDate;
                if (draft.seatPriceMap) seatPriceMap = draft.seatPriceMap;

                // n·∫øu ƒë√£ c√≥ showTimeId th√¨ load l·∫°i gh·∫ø
                if (bookingData?.showTimeId) {
                    loadAndRenderSeats(bookingData.showTimeId);
                    // quay v·ªÅ b∆∞·ªõc ch·ªçn gh·∫ø ƒë·ªÉ user b·∫•m ti·∫øp
                    goToStep(2);
                    updateSummary();
                }
            } catch (e) {}
        }

        async function handleSeatSelectionNext() {
            // 1. Validate d·ªØ li·ªáu b∆∞·ªõc 2
            if (bookingData.seats.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt gh·∫ø!');
                return;
            }
            // ‚úÖ B·∫ÆT BU·ªòC LOGIN (KH√ÅCH H√ÄNG)
            const userId = getUserIdFromAuth();
            if (!userId) {
                saveBookingDraft();
                const redirect = encodeURIComponent(window.location.href);
                window.location.href = `TaiKhoan.html?redirect=${redirect}`;
                return;
            }

            const holdPayload = {
                showId: bookingData.showTimeId,
                userId: userId,
                seats: bookingData.seats
            };

            try {
                // UI Loading
                const btnNext = document.querySelector('#seatSelection .btn-primary');
                const oldText = btnNext.textContent;
                btnNext.textContent = "ƒêang x·ª≠ l√Ω...";
                btnNext.disabled = true;

                // 2. G·ªçi API Gi·ªØ ch·ªó
                console.log("‚è≥ ƒêang gi·ªØ ch·ªó...", holdPayload);
                const holdResult = await apiFetch("/bookings/hold", {
                    method: "POST",
                    body: JSON.stringify(holdPayload)
                });

                console.log("‚úÖ Gi·ªØ gh·∫ø th√†nh c√¥ng!", holdResult);
                goToStep(3);

                updateSummary();
                console.log("[After hold] seatSelection active?",
                    document.getElementById("seatSelection")?.classList.contains("active"));
                console.log("[After hold] paymentSection active?",
                    document.getElementById("paymentSection")?.classList.contains("active"),
                    "display=",
                    getComputedStyle(document.getElementById("paymentSection")).display
                );

            } catch (e) {
                console.error("L·ªói gi·ªØ gh·∫ø:", e);
                alert("Kh√¥ng th·ªÉ gi·ªØ gh·∫ø: " + e.message + "\nGh·∫ø c√≥ th·ªÉ ƒë√£ b·ªã ng∆∞·ªùi kh√°c ch·ªçn. Vui l√≤ng ch·ªçn l·∫°i.");

                // Load l·∫°i s∆° ƒë·ªì ƒë·ªÉ c·∫≠p nh·∫≠t gh·∫ø ƒë·ªè
                loadAndRenderSeats(bookingData.showTimeId);
            } finally {
                // Reset n√∫t
                const btnNext = document.querySelector('#seatSelection .btn-primary');
                btnNext.textContent = "Ti·∫øp Theo";
                btnNext.disabled = false;
            }
        }
        // --- LOGIC HI·ªÇN TH·ªä MODAL VIETQR ---
        function openVietQRModal(data) {
            const modal = document.getElementById('successModal');
            const content = modal.querySelector('.modal-content');

            // L∆∞u l·∫°i n·ªôi dung g·ªëc (ƒë·ªÉ reset n·∫øu c·∫ßn) ho·∫∑c ghi ƒë√® lu√¥n
            // ·ªû ƒë√¢y ta ghi ƒë√® n·ªôi dung Modal th√†nh form qu√©t QR
            content.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="color:var(--primary); margin-bottom: 10px;">Qu√©t M√£ Thanh To√°n</h2>
                    <p>Vui l√≤ng m·ªü App Ng√¢n h√†ng ƒë·ªÉ qu√©t m√£:</p>

                    <div style="margin: 20px auto; display: inline-block; padding: 10px; background: white; border-radius: 8px;">
                        <img src="${data.qrDataURL}" alt="M√£ VietQR" style="display: block; max-width: 250px; height: auto;">
                    </div>

                    <p style="font-size: 0.9rem; color: #ccc;">
                        S·ªë ti·ªÅn: <strong style="color: #fff; font-size: 1.2rem;">${bookingData.totalPrice.toLocaleString()} ƒë</strong>
                    </p>

                    <div style="margin-top: 2rem; display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-outline" onclick="closeModal()">ƒê√≥ng</button>
                        <button class="btn btn-success" onclick="finishTransfer()">ƒê√£ Chuy·ªÉn Kho·∫£n</button>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // H√†m x·ª≠ l√Ω khi b·∫•m "ƒê√£ chuy·ªÉn kho·∫£n"
        function finishTransfer() {
            alert("H·ªá th·ªëng ƒëang x·ª≠ l√Ω giao d·ªãch c·ªßa b·∫°n. Vui l√≤ng ki·ªÉm tra email.");
            window.location.href = "TrangChu.html"; // Ho·∫∑c chuy·ªÉn v·ªÅ trang l·ªãch s·ª≠ v√©
        }
        // N√∫t "Quay l·∫°i"
        function goBack(step) {
            goToStep(step);
        }


        function redirectToTaiKhoan() { window.location.href = 'TaiKhoan.html'; }
        function closeModal() { document.getElementById('successModal').style.display = 'none'; }
        function printTicket() { alert('Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn'); }
        function closeVietQRModal() { /* ... */ }
    </script>

</body>
</html>