<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CineMax - L·ªãch Chi·∫øu</title>
  <style>
    body { background-color: #221f1f; color: #fff; font-family: 'Segoe UI'; margin: 0; }
    header, footer { background-color: #000; padding: 1rem 2rem; }
    .container { max-width: 1200px; margin: auto; padding: 2rem; }
    .section-title { font-size: 2rem; border-bottom: 2px solid #e50914; margin-bottom: 1.5rem; }
    .schedule-table { width: 100%; border-collapse: collapse; background-color: rgba(255,255,255,0.05); margin-top: 1rem; }
    .schedule-table th, .schedule-table td { padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.12); vertical-align: middle; }
    .schedule-table th { background-color: rgba(255,255,255,0.06); color: #e50914; text-align:left; }
    .movie-poster { width:56px; height:80px; object-fit:cover; border-radius:4px; margin-right:0.75rem; vertical-align:middle; }
    .movie-cell { display:flex; align-items:center; gap:0.5rem; }
    .time-button { background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.12); padding:6px 10px; margin:3px; border-radius:6px; cursor:pointer; text-decoration:none; display:inline-block; }
    .time-button:hover { background:#e50914; border-color:#e50914; }
    .controls { display:flex; gap:12px; align-items:center; margin-bottom:0.75rem; flex-wrap:wrap; }
    .date-input { padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:#fff; }
    .btn-primary { background-color: #e50914; color: white; padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; }
    .btn-primary:hover { background-color: #b2070f; }
    .empty { padding:2rem; text-align:center; color:#aaa; }
    @media (max-width:720px) { .movie-poster{width:44px;height:64px} .section-title{font-size:1.4rem} }
  </style>
</head>
<body>
  <header>
    <a href="TrangChu.html" style="color:#e50914;font-size:1.8rem;text-decoration:none;font-weight:bold;">Cine<span style="color:#fff;">Max</span></a>
  </header>

  <main class="container">
    <h2 class="section-title">üéüÔ∏è L·ªãch Chi·∫øu</h2>

    <div class="controls">
      <label>
        Ch·ªçn ng√†y:
        <input id="datePicker" class="date-input" type="date">
      </label>
      <button id="refreshBtn" class="btn-primary">T·∫£i l·∫°i</button>
      <div id="status" style="color:#aaa;font-size:0.95rem;margin-left:8px;"></div>
    </div>

    <div id="scheduleArea">
      <table id="scheduleTable" class="schedule-table" aria-live="polite">
        <thead>
          <tr>
            <th>Phim</th>
            <th>R·∫°p</th>
            <th>Su·∫•t</th>
          </tr>
        </thead>
        <tbody id="scheduleBody">
          <tr><td colspan="3" class="empty">ƒêang t·∫£i l·ªãch chi·∫øu...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <footer style="text-align:center;color:#757575;">
    ¬© 2025 CineMax. All rights reserved.
  </footer>

  <script>
<<<<<<< Updated upstream
    // ‚≠êÔ∏è C·∫§U H√åNH API TH·∫¨T (Tr·ªè v·ªÅ Gateway 4000)
    const API_GATEWAY = 'http://localhost:4000/api/movies';
    
    // (V·∫´n gi·ªØ API Key OMDb ƒë·ªÉ l·∫•y ·∫£nh n·∫øu database thi·∫øu)
    const OMDB_KEY = 'fa85c569'; 
    const posterCache = {};
=======
    const API_KEY = 'fa85c569';
    const BASE_URL = 'https://www.omdbapi.com/';
    const API_URL = ''; 

    const posterCache = {};
    const sampleMovies = [
      { movieId: 'tt0133093', title: 'The Matrix', poster: 'https://m.media-amazon.com/images/M/MV5BNzQzOTk3NjAt...jpg', genre: 'H√†nh ƒë·ªông' },
      { movieId: 'tt1375666', title: 'Inception', poster: 'https://m.media-amazon.com/images/M/MV5BMjAxMzY3NjY4...jpg', genre: 'Phi√™u l∆∞u' },
      { movieId: 'tt0111161', title: 'The Shawshank Redemption', poster: '', genre: 'Drama' },
      { movieId: 'tt0137523', title: 'Fight Club', poster: '', genre: 'T√¢m l√Ω' },
      { movieId: 'tt0120737', title: 'The Lord of the Rings', poster: '', genre: 'Phi√™u l∆∞u' },
      { movieId: 'tt0468569', title: 'The Dark Knight', poster: '', genre: 'H√†nh ƒë·ªông' },
      { movieId: 'tt4154796', title: 'Avengers: Endgame', poster: '', genre: 'H√†nh ƒë·ªông' },
      { movieId: 'tt4154756', title: 'Avengers: Infinity War', poster: '', genre: 'H√†nh ƒë·ªông' }
    ];

    const demoCinemas = [
      { name: 'CGV Diamond', location: 'Qu·∫≠n 1, TP.HCM' },
      { name: 'Galaxy Nguy·ªÖn Du', location: 'Qu·∫≠n 1, TP.HCM' },
      { name: 'BHD Star', location: 'Qu·∫≠n 7, TP.HCM' },
      { name: 'Lotte Cinema', location: 'Qu·∫≠n 7, TP.HCM' },
      { name: 'CineStar', location: 'Qu·∫≠n 3, TP.HCM' }
    ];

    const possibleTimes = ['09:00','10:30','12:00','13:30','15:00','16:30','18:00','19:30','21:00','22:30'];

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function pickRandom(arr, k) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a.slice(0, Math.min(k, a.length));
    }

    function generateRandomShows(date) {
      const count = randInt(4, 8); 
      const movies = pickRandom(sampleMovies, count);
      return movies.map(m => {
        const cinema = demoCinemas[randInt(0, demoCinemas.length - 1)];
        const timesCount = randInt(3, 6);
        const times = pickRandom(possibleTimes, timesCount).sort((a,b) => a.localeCompare(b));
        return {
          movieId: m.movieId,
          title: m.title,
          poster: m.poster,
          genre: m.genre,
          cinema: `${cinema.name}`,
          location: cinema.location,
          date,
          times
        };
      });
    }
>>>>>>> Stashed changes

    const datePicker = document.getElementById('datePicker');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const scheduleBody = document.getElementById('scheduleBody');

<<<<<<< Updated upstream
    // M·∫∑c ƒë·ªãnh ch·ªçn ng√†y h√¥m nay
=======
>>>>>>> Stashed changes
    const today = new Date().toISOString().slice(0,10);
    datePicker.value = today;

    refreshBtn.addEventListener('click', loadSchedule);
    datePicker.addEventListener('change', loadSchedule);

<<<<<<< Updated upstream
    // 1. H√†m g·ªçi API l·∫•y l·ªãch chi·∫øu th·∫≠t
    async function fetchShowtimes(date) {
        try {
            // G·ªçi Gateway -> MovieService
            const res = await fetch(`${API_GATEWAY}/schedule?date=${date}`);
            if (!res.ok) throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi Server');
            
            const data = await res.json(); // M·∫£ng c√°c su·∫•t chi·∫øu (Showtime)
            
            // Gom nh√≥m d·ªØ li·ªáu: Server tr·∫£ v·ªÅ danh s√°ch ph·∫≥ng, ta c·∫ßn gom theo Phim
            return processData(data);

        } catch (err) {
            console.error(err);
            throw err;
        }
    }

    // 2. H√†m x·ª≠ l√Ω d·ªØ li·ªáu (Gom nh√≥m Su·∫•t chi·∫øu v√†o t·ª´ng Phim)
    async function processData(showtimes) {
        if (!showtimes || showtimes.length === 0) return [];

        const movieMap = {};

        for (const show of showtimes) {
            const movie = show.movie;
            if (!movie) continue;

            if (!movieMap[movie.id]) {
                // N·∫øu ch∆∞a c√≥ phim n√†y trong danh s√°ch, t·∫°o m·ªõi
                // N·∫øu DB c√≥ posterUrl th√¨ d√πng, n·∫øu kh√¥ng th√¨ t√¨m OMDb sau
                let poster = movie.posterUrl;
                if (!poster || poster.trim() === '') {
                    poster = await fetchPosterByTitle(movie.title); 
                }

                movieMap[movie.id] = {
                    movieId: movie.id,
                    title: movie.title,
                    poster: poster || 'https://via.placeholder.com/80x120?text=No+Img',
                    genre: movie.description || 'Phim hay',
                    cinema: show.roomId, // T·∫°m th·ªùi d√πng roomId l√†m t√™n r·∫°p
                    location: 'CineMax Center',
                    times: []
                };
            }
            
            // Th√™m gi·ªù chi·∫øu v√†o phim
            const timeStr = new Date(show.startTime).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            
            // L∆∞u c·∫£ gi·ªù v√† ID su·∫•t chi·∫øu ƒë·ªÉ t·∫°o link
            movieMap[movie.id].times.push({
                time: timeStr,
                showtimeId: show.id 
            });
        }

        return Object.values(movieMap);
    }
    
    // H√†m ph·ª•: T√¨m poster tr√™n OMDb n·∫øu DB ch∆∞a c√≥
    async function fetchPosterByTitle(title) {
        if (posterCache[title]) return posterCache[title];
        try {
            const res = await fetch(`https://www.omdbapi.com/?t=${encodeURIComponent(title)}&apikey=${OMDB_KEY}`);
            const json = await res.json();
            const poster = (json.Poster && json.Poster !== 'N/A') ? json.Poster : '';
            posterCache[title] = poster;
            return poster;
        } catch { return ''; }
    }

    // 3. H√†m V·∫Ω Giao Di·ªán (Render)
    function renderShowRows(shows) {
        scheduleBody.innerHTML = '';
        if (!shows || shows.length === 0) {
            scheduleBody.innerHTML = '<tr><td colspan="3" class="empty">Kh√¥ng c√≥ l·ªãch chi·∫øu cho ng√†y n√†y.</td></tr>';
            return;
        }

        shows.forEach(show => {
            const tr = document.createElement('tr');

            // C·ªôt Phim
            const movieCell = document.createElement('td');
            movieCell.innerHTML = `
                <div class="movie-cell">
                    <img class="movie-poster" src="${show.poster}" alt="${show.title}">
                    <div>
                        <div style="font-weight:700">${show.title}</div>
                        <div style="font-size:0.9rem;color:#bbb">${show.genre}</div>
                    </div>
                </div>`;

            // C·ªôt R·∫°p
            const cinemaCell = document.createElement('td');
            cinemaCell.innerHTML = `
                <div style="font-weight:600">${show.cinema}</div>
                <div style="color:#aaa;font-size:0.9rem">${show.location}</div>`;

            // C·ªôt Su·∫•t Chi·∫øu (T·∫°o n√∫t b·∫•m chuy·ªÉn sang DatVe.html)
            const timesCell = document.createElement('td');
            if (show.times.length > 0) {
                show.times.forEach(item => {
                    const a = document.createElement('a');
                    a.className = 'time-button';
                    // ‚≠êÔ∏è LINK SANG TRANG ƒê·∫∂T V√â (K√àM ID SU·∫§T CHI·∫æU TH·∫¨T) ‚≠êÔ∏è
                    a.href = `DatVe.html?showtimeId=${item.showtimeId}`; 
                    a.textContent = item.time;
                    timesCell.appendChild(a);
                });
            } else {
                timesCell.innerHTML = `<span style="color:#aaa">H·∫øt su·∫•t</span>`;
            }

            tr.appendChild(movieCell);
            tr.appendChild(cinemaCell);
            tr.appendChild(timesCell);
            scheduleBody.appendChild(tr);
        });
    }

    async function loadSchedule() {
        const date = datePicker.value || today;
        statusEl.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu th·∫≠t...';
        try {
            const shows = await fetchShowtimes(date);
            renderShowRows(shows);
            statusEl.textContent = `T√¨m th·∫•y: ${shows.length} phim`;
        } catch (err) {
            console.error(err);
            scheduleBody.innerHTML = '<tr><td colspan="3" class="empty">L·ªói k·∫øt n·ªëi server (4000/4002).</td></tr>';
            statusEl.textContent = 'L·ªói';
        }
    }

    // Ch·∫°y ngay khi v√†o trang
    loadSchedule();
</script>
=======
    async function fetchShowtimes(date) {
      if (API_URL && !API_URL.includes('example.com')) {
        try {
          const res = await fetch(`${API_URL}?date=${encodeURIComponent(date)}`);
          if (!res.ok) throw new Error('L·ªói khi t·∫£i d·ªØ li·ªáu');
          const json = await res.json();
          // n·∫øu api l·ªãch chi·∫øu tr·∫£ movieId nh∆∞ng kh√¥ng c√≥ poster -> c·ªë g·∫Øng l·∫•y t·ª´ OMDb
          return await enrichShowsWithPosters(json);
        } catch (err) {
          console.error(err);
          throw err;
        }
      }
      await new Promise(r => setTimeout(r, 300));
      const shows = generateRandomShows(date);
      return await enrichShowsWithPosters(shows);
    }
    
    async function fetchPosterByImdb(imdbID) {
      if (!imdbID) return '';
      if (posterCache[imdbID]) return posterCache[imdbID];
      try {
        const res = await fetch(`${BASE_URL}?i=${encodeURIComponent(imdbID)}&apikey=${API_KEY}`);
        if (!res.ok) throw new Error('OMDb l·ªói');
        const json = await res.json();
        const poster = (json && json.Poster && json.Poster !== 'N/A') ? json.Poster : '';
        posterCache[imdbID] = poster;
        return poster;
      } catch (e) {
        console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c poster cho', imdbID, e);
        posterCache[imdbID] = '';
        return '';
      }
    }

    async function enrichShowsWithPosters(shows) {
      if (!Array.isArray(shows)) return shows;
      const tasks = shows.map(async show => {
        if ((!show.poster || show.poster === '') && show.movieId) {
          const p = await fetchPosterByImdb(show.movieId);
          if (p) show.poster = p;
        }
        return show;
      });
      return Promise.all(tasks);
    }

    function clearTable() {
      scheduleBody.innerHTML = '';
    }

    function renderEmpty(message) {
      clearTable();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3" class="empty">${message}</td>`;
      scheduleBody.appendChild(tr);
    }

    function renderShowRows(shows) {
      clearTable();
      if (!shows || shows.length === 0) {
        renderEmpty('Kh√¥ng c√≥ l·ªãch chi·∫øu cho ng√†y n√†y.');
        return;
      }
      shows.forEach(show => {
        const tr = document.createElement('tr');

        const poster = show.poster && show.poster !== '' ? show.poster : 'https://via.placeholder.com/80x120/1a2a3a/ffffff?text=No+Image';

        const movieCell = document.createElement('td');
        movieCell.innerHTML = `<div class="movie-cell"><img class="movie-poster" src="${poster}" alt="${escapeHtml(show.title)}"><div>
          <div style="font-weight:700">${escapeHtml(show.title)}</div>
          <div style="font-size:0.9rem;color:#bbb">${escapeHtml(show.genre || '')}</div>
        </div></div>`;

        const cinemaCell = document.createElement('td');
        cinemaCell.innerHTML = `<div style="font-weight:600">${escapeHtml(show.cinema)}</div><div style="color:#aaa;font-size:0.9rem">${escapeHtml(show.location || '')}</div>`;

        const timesCell = document.createElement('td');
        if (Array.isArray(show.times) && show.times.length > 0) {
          const fragment = document.createDocumentFragment();
          show.times.forEach(time => {
            const a = document.createElement('a');
            a.className = 'time-button';
            const href = `DatVe.html?movieId=${encodeURIComponent(show.movieId || '')}&title=${encodeURIComponent(show.title || '')}&cinema=${encodeURIComponent(show.cinema || '')}&time=${encodeURIComponent(time)}`;
            a.href = href;
            a.textContent = time;
            fragment.appendChild(a);
          });
          timesCell.appendChild(fragment);
        } else {
          timesCell.innerHTML = `<span style="color:#aaa">Ch∆∞a c√≥ su·∫•t</span>`;
        }

        tr.appendChild(movieCell);
        tr.appendChild(cinemaCell);
        tr.appendChild(timesCell);
        scheduleBody.appendChild(tr);
      });
    }

    function escapeHtml(str = '') {
      return String(str).replace(/[&<>"']/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }

    async function loadSchedule() {
      const date = datePicker.value || today;
      statusEl.textContent = 'ƒêang t·∫£i...';
      try {
        const shows = await fetchShowtimes(date);
        renderShowRows(shows);
        statusEl.textContent = `ƒê√£ t·∫£i: ${shows.length} m·ª•c`;
      } catch (err) {
        console.error(err);
        renderEmpty('L·ªói khi t·∫£i l·ªãch chi·∫øu. Vui l√≤ng th·ª≠ l·∫°i.');
        statusEl.textContent = 'L·ªói';
      }
    }
    loadSchedule();
  </script>
>>>>>>> Stashed changes
</body>
</html>
